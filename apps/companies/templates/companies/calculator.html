{% extends 'base.html' %}

{% block title %}재무 지표 계산기 - 장기 투자 분석{% endblock %}

{% block content %}
<div class="row" x-data="pasteCalculator()"
    data-tax-rate="{{ calculator_defaults.TAX_RATE|default:25 }}"
    data-equity-risk-premium="{{ calculator_defaults.EQUITY_RISK_PREMIUM|default:5.0 }}">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title mb-4">
                    <i class="bi bi-calculator me-2"></i>재무 지표 계산기
                </h2>
                <p class="text-muted mb-4">
                    사업보고서에서 연결 재무상태표·연결 현금흐름표를 복사하여 붙여넣으면
                    FCF, ROIC, WACC를 자동 계산하고 DB에 저장합니다. 자본총계는 DB 기존 데이터를 사용합니다.
                </p>

                <!-- 기업 선택 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">기업 선택</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="corp_code" class="form-label">기업코드 / 종목코드 <span class="text-danger">*</span></label>
                                <input type="text" id="corp_code" x-model="corpCode" class="form-control"
                                    placeholder="예: 00126380 또는 005930">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 복붙 입력 -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">연결 재무상태표</h5>
                                <small class="text-muted">사업보고서에서 재무상태표 전체를 복사하여 붙여넣으세요</small>
                            </div>
                            <div class="card-body p-3">
                                <textarea x-model="balanceSheet" class="form-control font-monospace" rows="18"
                                    placeholder="2-1. 연결 재무상태표&#10;연결 재무상태표&#10;제 23 기 2024.12.31 현재&#10;..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">연결 현금흐름표</h5>
                                <small class="text-muted">사업보고서에서 현금흐름표 전체를 복사하여 붙여넣으세요</small>
                            </div>
                            <div class="card-body p-3">
                                <textarea x-model="cashFlow" class="form-control font-monospace" rows="18"
                                    placeholder="2-4. 연결 현금흐름표&#10;연결 현금흐름표&#10;제 23 기 2024.01.01 ~ 2024.12.31&#10;..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 계산 옵션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">
                            계산 옵션
                            <span x-show="loadingDefaults" class="text-muted small ms-2">(기본값 불러오는 중…)</span>
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="tax_rate" class="form-label">법인세율 (%)</label>
                                <input type="number" id="tax_rate" x-model.number="taxRate" class="form-control"
                                    step="0.1" min="0" max="100" placeholder="25">
                                <div class="form-text">기본값: {{ calculator_defaults.TAX_RATE|default:25 }}%</div>
                            </div>
                            <div class="col-md-4">
                                <label for="bond_yield" class="form-label">국채수익률 (%)</label>
                                <input type="number" id="bond_yield" x-model.number="bondYield" class="form-control"
                                    step="0.1" min="0" max="100" placeholder="3.5">
                            </div>
                            <div class="col-md-4">
                                <label for="equity_risk_premium" class="form-label">주주기대수익률 (%)</label>
                                <input type="number" id="equity_risk_premium" x-model.number="equityRiskPremium"
                                    class="form-control" step="0.1" min="0" max="100" placeholder="5.0">
                                <div class="form-text">기본값: {{ calculator_defaults.EQUITY_RISK_PREMIUM|default:5.0 }}%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 실행 버튼 -->
                <div class="mb-4">
                    <button type="button" class="btn btn-primary btn-lg" @click="parseAndCalculate()" :disabled="loading">
                        <span x-show="!loading"><i class="bi bi-play-fill me-2"></i>파싱 및 계산 실행</span>
                        <span x-show="loading"><span class="spinner-border spinner-border-sm me-2"></span>처리 중...</span>
                    </button>
                </div>

                <!-- 메시지 -->
                <div x-show="message" class="mb-3">
                    <div :class="messageType === 'success' ? 'alert alert-success' : 'alert alert-danger'" x-text="message"></div>
                </div>

                <!-- 결과 표시 -->
                <div x-show="results.length > 0" class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">계산 결과 (DB 저장 완료)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>연도</th>
                                        <th>FCF (자유현금흐름)</th>
                                        <th>ROIC (%)</th>
                                        <th>WACC (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="r in results" :key="r.year">
                                        <tr>
                                            <td x-text="r.year"></td>
                                            <td x-text="formatNumber(r.fcf)"></td>
                                            <td x-text="(r.roic * 100).toFixed(2)"></td>
                                            <td x-text="(r.wacc * 100).toFixed(2)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 에러(건너뜀) 표시 -->
                <div x-show="errors && errors.length > 0" class="alert alert-warning">
                    <h6 class="alert-heading">건너뛴 연도</h6>
                    <ul class="mb-0">
                        <template x-for="e in errors" :key="e.year">
                            <li><span x-text="e.year"></span>년: <span x-text="e.error"></span></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function pasteCalculator() {
        const el = document.querySelector('[x-data="pasteCalculator()"]');
        const taxRateDefault = el && el.dataset.taxRate != null ? parseFloat(el.dataset.taxRate) : 25;
        const erpDefault = el && el.dataset.equityRiskPremium != null ? parseFloat(el.dataset.equityRiskPremium) : 5.0;

        return {
            corpCode: '',
            balanceSheet: '',
            cashFlow: '',
            taxRate: taxRateDefault,
            bondYield: 3.5,
            equityRiskPremium: erpDefault,
            loading: false,
            results: [],
            errors: [],
            message: null,
            messageType: 'success',
            loadingDefaults: true,

            async init() {
                const params = new URLSearchParams(window.location.search);
                const corpFromUrl = params.get('corp_code');
                if (corpFromUrl && corpFromUrl.trim()) {
                    this.corpCode = corpFromUrl.trim();
                }
                if (this.corpCode) {
                    try {
                        const year = new Date().getFullYear() - 1;
                        const res = await fetch(`/api/companies/${encodeURIComponent(this.corpCode)}/calculator-data/?year=${year}`);
                        const data = await res.json();
                        if (res.ok && data.bond_yield_5y != null) {
                            this.bondYield = (data.bond_yield_5y * 100);
                        }
                    } catch (e) {
                        console.warn('calculator-data fetch failed:', e);
                    }
                }
                this.loadingDefaults = false;
            },

            async parseAndCalculate() {
                if (!this.corpCode || !this.balanceSheet.trim() || !this.cashFlow.trim()) {
                    this.message = '기업코드와 재무상태표·현금흐름표를 모두 입력해주세요.';
                    this.messageType = 'error';
                    setTimeout(() => { this.message = null; }, 5000);
                    return;
                }

                this.loading = true;
                this.results = [];
                this.errors = [];
                this.message = null;

                try {
                    const response = await fetch(`/api/companies/${encodeURIComponent(this.corpCode)}/parse-paste/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            balance_sheet: this.balanceSheet,
                            cash_flow: this.cashFlow,
                            tax_rate: this.taxRate,
                            bond_yield: this.bondYield,
                            equity_risk_premium: this.equityRiskPremium
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.results = data.results || [];
                        this.errors = data.errors || [];
                        this.message = this.results.length + '개 연도 저장되었습니다.';
                        this.messageType = 'success';
                    } else {
                        this.message = data.error || '처리 실패.';
                        this.messageType = 'error';
                        if (data.errors && data.errors.length > 0) {
                            this.errors = data.errors;
                        }
                    }
                } catch (err) {
                    this.message = 'API 호출 실패: ' + err.message;
                    this.messageType = 'error';
                } finally {
                    this.loading = false;
                    if (this.message) {
                        setTimeout(() => { this.message = null; }, 5000);
                    }
                }
            },

            getCsrfToken() {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let c of cookies) {
                    const [k, v] = c.trim().split('=');
                    if (k === name) return decodeURIComponent(v || '');
                }
                return '';
            },

            formatNumber(num) {
                if (num == null) return '-';
                return new Intl.NumberFormat('ko-KR').format(num);
            }
        };
    }
</script>
{% endblock %}
