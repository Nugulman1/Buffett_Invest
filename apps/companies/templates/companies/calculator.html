{% extends 'base.html' %}

{% block title %}재무 지표 계산기 - 장기 투자 분석{% endblock %}

{% block content %}
<div x-data="financialCalculator()" class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title mb-4">
                    <i class="bi bi-calculator me-2"></i>재무 지표 계산기
                </h2>
                <p class="text-muted mb-4">
                    사업보고서에서 직접 수치를 입력하여 FCF, ROIC, WACC를 계산하고 DB에 저장할 수 있습니다.
                </p>

                <!-- 기본 정보 섹션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">기본 정보</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="corp_code" class="form-label">기업코드 <span
                                        class="text-danger">*</span></label>
                                <input type="text" id="corp_code" x-model="formData.corp_code" class="form-control"
                                    placeholder="예: 00126380">
                            </div>
                            <div class="col-md-6">
                                <label for="year" class="form-label">년도 <span class="text-danger">*</span></label>
                                <input type="number" id="year" x-model.number="formData.year" class="form-control"
                                    placeholder="예: 2023" min="2000" max="2100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 공통 필드 섹션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">공통 필드</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="equity" class="form-label">자기자본 <span class="text-muted">(원)</span></label>
                                <input type="text" id="equity" x-model="formData.equity"
                                    @input="formatNumberInput($event, 'formData.equity'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="tax_rate" class="form-label">법인세율 <span
                                        class="text-muted">(%)</span></label>
                                <input type="number" id="tax_rate" x-model.number="formData.tax_rate"
                                    @input="calculateAll()" class="form-control" placeholder="25" step="0.1" min="0"
                                    max="100">
                                <div class="form-text">기본값: 25%</div>
                            </div>
                            <div class="col-md-6">
                                <label for="bond_yield" class="form-label">국채수익률 <span
                                        class="text-muted">(%)</span></label>
                                <input type="number" id="bond_yield" x-model.number="formData.bond_yield"
                                    @input="calculateAll()" class="form-control" placeholder="3.5" step="0.1" min="0"
                                    max="100">
                            </div>
                            <div class="col-md-6">
                                <label for="equity_risk_premium" class="form-label">주주기대수익률 <span
                                        class="text-muted">(%)</span></label>
                                <input type="number" id="equity_risk_premium"
                                    x-model.number="formData.equity_risk_premium" @input="calculateAll()"
                                    class="form-control" placeholder="5.0" step="0.1" min="0" max="100">
                                <div class="form-text">기본값: 5%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 이자부채 섹션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">이자부채</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="short_term_borrowings" class="form-label">단기차입금 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="short_term_borrowings" x-model="formData.short_term_borrowings"
                                    @input="formatNumberInput($event, 'formData.short_term_borrowings'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="current_portion" class="form-label">유동성장기차입금 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="current_portion"
                                    x-model="formData.current_portion_of_long_term_borrowings"
                                    @input="formatNumberInput($event, 'formData.current_portion_of_long_term_borrowings'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="long_term_borrowings" class="form-label">장기차입금 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="long_term_borrowings" x-model="formData.long_term_borrowings"
                                    @input="formatNumberInput($event, 'formData.long_term_borrowings'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="bonds" class="form-label">사채 <span class="text-muted">(원)</span></label>
                                <input type="text" id="bonds" x-model="formData.bonds"
                                    @input="formatNumberInput($event, 'formData.bonds'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="lease_liabilities" class="form-label">리스부채 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="lease_liabilities" x-model="formData.lease_liabilities"
                                    @input="formatNumberInput($event, 'formData.lease_liabilities'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="convertible_bonds" class="form-label">전환부채 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="convertible_bonds" x-model="formData.convertible_bonds"
                                    @input="formatNumberInput($event, 'formData.convertible_bonds'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FCF 전용 필드 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">FCF 계산용 필드</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="cfo" class="form-label">CFO (영업활동현금흐름) <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="cfo" x-model="formData.cfo"
                                    @input="formatNumberInput($event, 'formData.cfo'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label for="tangible" class="form-label">유형자산 취득 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="tangible" x-model="formData.tangible_asset_acquisition"
                                    @input="formatNumberInput($event, 'formData.tangible_asset_acquisition'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-4">
                                <label for="intangible" class="form-label">무형자산 취득 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="intangible" x-model="formData.intangible_asset_acquisition"
                                    @input="formatNumberInput($event, 'formData.intangible_asset_acquisition'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROIC 전용 필드 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">ROIC 계산용 필드</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="operating_income" class="form-label">영업이익 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="operating_income" x-model="formData.operating_income"
                                    @input="formatNumberInput($event, 'formData.operating_income'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label for="cash" class="form-label">현금및현금성자산 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="cash" x-model="formData.cash_and_cash_equivalents"
                                    @input="formatNumberInput($event, 'formData.cash_and_cash_equivalents'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WACC 전용 필드 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">WACC 계산용 필드</h4>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="interest_expense" class="form-label">이자비용 <span
                                        class="text-muted">(원)</span></label>
                                <input type="text" id="interest_expense" x-model="formData.interest_expense"
                                    @input="formatNumberInput($event, 'formData.interest_expense'); calculateAll()"
                                    class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 계산 결과 섹션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">계산 결과</h4>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-2">FCF (자유현금흐름)</h6>
                                    <div class="fs-4 fw-bold text-primary" x-text="formatAmount(fcfResult)"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-2">ROIC (투하자본수익률)</h6>
                                    <div class="fs-4 fw-bold text-primary" x-text="formatPercent(roicResult)"></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="text-muted mb-2">WACC (가중평균자본비용)</h6>
                                    <div class="fs-4 fw-bold text-primary" x-text="formatPercent(waccResult)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 저장 버튼 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">DB에 저장</h5>
                                <small class="text-muted">계산 결과를 데이터베이스에 저장합니다.</small>
                            </div>
                            <button type="button" class="btn btn-primary btn-lg" @click="saveToDB()" :disabled="saving">
                                <span x-show="!saving">
                                    <i class="bi bi-save me-2"></i>저장
                                </span>
                                <span x-show="saving">
                                    <span class="spinner-border spinner-border-sm me-2"></span>저장 중...
                                </span>
                            </button>
                        </div>
                        <div x-show="saveMessage" class="mt-3">
                            <div :class="saveMessageType === 'success' ? 'alert alert-success' : 'alert alert-danger'">
                                <span x-text="saveMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function financialCalculator() {
        return {
            formData: {
                corp_code: '',
                year: null,
                equity: null,
                tax_rate: 25,
                bond_yield: null,
                equity_risk_premium: 5.0,
                short_term_borrowings: null,
                current_portion_of_long_term_borrowings: null,
                long_term_borrowings: null,
                bonds: null,
                lease_liabilities: null,
                convertible_bonds: null,
                cfo: null,
                tangible_asset_acquisition: null,
                intangible_asset_acquisition: null,
                operating_income: null,
                cash_and_cash_equivalents: null,
                interest_expense: null
            },
            fcfResult: null,
            roicResult: null,
            waccResult: null,
            saving: false,
            saveMessage: null,
            saveMessageType: null,

            // 숫자 입력 포맷팅 (천 단위 구분자 추가)
            formatNumberInput(event, dataPath) {
                let value = event.target.value;
                const numericValue = value.replace(/,/g, '');

                if (numericValue === '' || numericValue === '-') {
                    this.setNestedValue(dataPath, numericValue);
                    return;
                }

                const num = parseFloat(numericValue);
                if (isNaN(num)) {
                    return;
                }

                const formatted = num.toLocaleString('ko-KR');
                this.setNestedValue(dataPath, formatted);
            },

            // 중첩된 객체 속성 설정 헬퍼
            setNestedValue(path, value) {
                const parts = path.split('.');
                if (parts.length === 2) {
                    this[parts[0]][parts[1]] = value;
                }
            },

            // 문자열에서 숫자 추출 (쉼표 제거)
            parseNumber(value) {
                if (value === null || value === undefined || value === '') {
                    return null;
                }
                const numericStr = String(value).replace(/,/g, '');
                const num = parseFloat(numericStr);
                return isNaN(num) ? null : num;
            },

            // 모든 계산 수행
            calculateAll() {
                this.calculateFCF();
                this.calculateROIC();
                this.calculateWACC();
            },

            // FCF 계산
            calculateFCF() {
                const cfo = this.parseNumber(this.formData.cfo);
                const tangible = this.parseNumber(this.formData.tangible_asset_acquisition);
                const intangible = this.parseNumber(this.formData.intangible_asset_acquisition);

                if (cfo === null || tangible === null || intangible === null) {
                    this.fcfResult = null;
                    return;
                }

                const capex = tangible + intangible;
                this.fcfResult = cfo - Math.abs(capex);
            },

            // ROIC 계산
            calculateROIC() {
                const operatingIncome = this.parseNumber(this.formData.operating_income);
                const taxRate = this.formData.tax_rate;
                const equity = this.parseNumber(this.formData.equity);
                const cash = this.parseNumber(this.formData.cash_and_cash_equivalents);

                if (operatingIncome === null || taxRate === null || equity === null || cash === null) {
                    this.roicResult = null;
                    return;
                }

                const interestBearingDebt = (
                    (this.parseNumber(this.formData.short_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.current_portion_of_long_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.long_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.bonds) || 0) +
                    (this.parseNumber(this.formData.lease_liabilities) || 0) +
                    (this.parseNumber(this.formData.convertible_bonds) || 0)
                );

                const denominator = equity + interestBearingDebt - cash;

                if (denominator === 0) {
                    this.roicResult = null;
                    return;
                }

                const taxRateDecimal = taxRate / 100;
                const numerator = operatingIncome * (1 - taxRateDecimal);
                this.roicResult = (numerator / denominator) * 100;
            },

            // WACC 계산
            calculateWACC() {
                const equity = this.parseNumber(this.formData.equity);
                const bondYield = this.formData.bond_yield;
                const equityRiskPremium = this.formData.equity_risk_premium;
                const taxRate = this.formData.tax_rate;

                if (equity === null || bondYield === null || equityRiskPremium === null || taxRate === null) {
                    this.waccResult = null;
                    return;
                }

                const interestBearingDebt = (
                    (this.parseNumber(this.formData.short_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.current_portion_of_long_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.long_term_borrowings) || 0) +
                    (this.parseNumber(this.formData.bonds) || 0) +
                    (this.parseNumber(this.formData.lease_liabilities) || 0) +
                    (this.parseNumber(this.formData.convertible_bonds) || 0)
                );

                const totalCapital = equity + interestBearingDebt;
                if (totalCapital === 0) {
                    this.waccResult = null;
                    return;
                }

                const costOfEquity = (bondYield + equityRiskPremium) / 100.0;
                let costOfDebt = 0.0;
                const interestExpense = this.parseNumber(this.formData.interest_expense);
                if (interestBearingDebt !== 0 && interestExpense !== null) {
                    costOfDebt = interestExpense / interestBearingDebt;
                }

                const equityWeight = equity / totalCapital;
                const debtWeight = interestBearingDebt / totalCapital;
                const taxRateDecimal = taxRate / 100;

                this.waccResult = ((equityWeight * costOfEquity) + (debtWeight * costOfDebt * (1 - taxRateDecimal))) * 100;
            },

            // DB에 저장
            async saveToDB() {
                if (!this.formData.corp_code || !this.formData.year) {
                    this.saveMessage = '기업코드와 년도를 입력해주세요.';
                    this.saveMessageType = 'error';
                    setTimeout(() => { this.saveMessage = null; }, 5000);
                    return;
                }

                this.saving = true;
                this.saveMessage = null;

                try {
                    // 요청 데이터 준비
                    const requestData = {
                        year: this.formData.year,
                        cfo: this.parseNumber(this.formData.cfo) || 0,
                        tangible_asset_acquisition: this.parseNumber(this.formData.tangible_asset_acquisition) || 0,
                        intangible_asset_acquisition: this.parseNumber(this.formData.intangible_asset_acquisition) || 0,
                        operating_income: this.parseNumber(this.formData.operating_income) || 0,
                        tax_rate: this.formData.tax_rate || 25,
                        equity: this.parseNumber(this.formData.equity) || 0,
                        short_term_borrowings: this.parseNumber(this.formData.short_term_borrowings) || 0,
                        current_portion_of_long_term_borrowings: this.parseNumber(this.formData.current_portion_of_long_term_borrowings) || 0,
                        long_term_borrowings: this.parseNumber(this.formData.long_term_borrowings) || 0,
                        bonds: this.parseNumber(this.formData.bonds) || 0,
                        lease_liabilities: this.parseNumber(this.formData.lease_liabilities) || 0,
                        convertible_bonds: this.parseNumber(this.formData.convertible_bonds) || 0,
                        cash_and_cash_equivalents: this.parseNumber(this.formData.cash_and_cash_equivalents) || 0,
                        interest_expense: this.parseNumber(this.formData.interest_expense) || 0,
                        bond_yield: this.formData.bond_yield || 0,
                        equity_risk_premium: this.formData.equity_risk_premium || 5.0
                    };

                    const response = await fetch(`/api/companies/${this.formData.corp_code}/calculated-indicators/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(requestData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.saveMessage = '저장되었습니다.';
                        this.saveMessageType = 'success';
                    } else {
                        this.saveMessage = data.error || '저장에 실패했습니다.';
                        this.saveMessageType = 'error';
                    }
                } catch (error) {
                    this.saveMessage = '저장 중 오류가 발생했습니다: ' + error.message;
                    this.saveMessageType = 'error';
                } finally {
                    this.saving = false;
                    setTimeout(() => { this.saveMessage = null; }, 5000);
                }
            },

            // CSRF 토큰 가져오기
            getCsrfToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            },

            // 포맷팅 메서드
            formatAmount(value) {
                if (value === null || value === undefined || value === '') {
                    return '-';
                }

                const numValue = Number(value);
                if (isNaN(numValue)) {
                    return '-';
                }

                if (numValue === 0) {
                    return '0원';
                }

                const jo = numValue / 1000000000000;
                if (jo >= 1) {
                    return jo.toFixed(2) + '조';
                } else {
                    const eok = numValue / 100000000;
                    return eok.toFixed(2) + '억';
                }
            },

            formatPercent(value) {
                if (value === null || value === undefined) {
                    return '-';
                }
                return value.toFixed(2) + '%';
            }
        }
    }
</script>
{% endblock %}