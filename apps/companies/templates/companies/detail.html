{% extends 'base.html' %}

{% block title %}기업 상세 정보 - 장기 투자 분석{% endblock %}

{% block content %}
<div x-data="companyDetail('{{ corp_code }}')" class="row">
    <div class="col-12">
        <!-- 로딩 상태 -->
        <div x-show="loading" class="text-center py-5">
            <div class="loading-spinner mx-auto mb-3"></div>
            <p class="text-muted">데이터를 불러오는 중...</p>
        </div>

        <!-- 에러 상태 -->
        <div x-show="error && !loading" class="alert alert-danger">
            <h5 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>오류 발생
            </h5>
            <p class="mb-0" x-text="error"></p>
        </div>

        <!-- 데이터 표시 -->
        <template x-if="!loading && !error && companyData">
            <div>
                <!-- 헤더 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h2 class="card-title mb-2" x-text="companyData?.company_name || '-'"></h2>
                                <p class="text-muted mb-2" x-text="companyData?.business_type_name || '-'"></p>
                                <p class="text-muted-small mb-0">
                                    <code x-text="companyData?.corp_code || '-'"></code>
                                </p>
                            </div>
                            <div>
                                <span class="badge fs-6 px-3 py-2"
                                    :class="companyData?.passed_all_filters ? 'bg-success' : 'bg-danger'"
                                    x-text="companyData?.passed_all_filters ? '필터 통과' : '필터 미통과'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 필터 결과 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">
                            <i class="bi bi-funnel me-2"></i>필터 결과
                        </h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">영업이익 필터:</span>
                                    <span class="badge"
                                        :class="companyData?.filter_operating_income ? 'bg-success' : 'bg-danger'"
                                        x-text="companyData?.filter_operating_income ? '통과' : '미통과'"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">당기순이익 필터:</span>
                                    <span class="badge"
                                        :class="companyData?.filter_net_income ? 'bg-success' : 'bg-danger'"
                                        x-text="companyData?.filter_net_income ? '통과' : '미통과'"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">매출액 CAGR 필터:</span>
                                    <span class="badge"
                                        :class="companyData?.filter_revenue_cagr ? 'bg-success' : 'bg-danger'"
                                        x-text="companyData?.filter_revenue_cagr ? '통과' : '미통과'"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">총자산 영업이익률 필터:</span>
                                    <span class="badge"
                                        :class="companyData?.filter_total_assets_operating_income_ratio ? 'bg-success' : 'bg-danger'"
                                        x-text="companyData?.filter_total_assets_operating_income_ratio ? '통과' : '미통과'"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">ROE 필터:</span>
                                    <span class="badge"
                                        :class="companyData?.filter_roe ? 'bg-success' : 'bg-danger'"
                                        x-text="companyData?.filter_roe ? '통과' : '미통과'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 기본 정보 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">
                            <i class="bi bi-info-circle me-2"></i>기본 정보
                        </h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>업종 코드:</strong>
                                <span x-text="companyData?.business_type_code || '-'"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>5년 만기 국채 수익률:</strong>
                                <span
                                    x-text="companyData?.bond_yield_5y ? (companyData.bond_yield_5y * 100).toFixed(2) + '%' : '-'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 재무 지표 테이블 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title mb-0">
                                <i class="bi bi-table me-2"></i>최근 5년 재무 지표
                            </h4>
                            <a :href="`/companies/${corpCode}/add-indicators/`" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>지표 추가
                            </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>연도</th>
                                        <th class="text-end">매출액</th>
                                        <th class="text-end">영업이익</th>
                                        <th class="text-end">당기순이익</th>
                                        <th class="text-end">총자산</th>
                                        <th class="text-end">자기자본</th>
                                        <!-- 매출총이익률과 판관비율은 현재 사용하지 않으므로 주석 처리 -->
                                        <!-- <th class="text-end">매출총이익률</th> -->
                                        <!-- <th class="text-end">판관비율</th> -->
                                        <th class="text-end">총자산 영업이익률</th>
                                        <th class="text-end">ROE</th>
                                        <th class="text-end">FCF</th>
                                        <th class="text-end">ROIC</th>
                                        <th class="text-end">WACC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="yearData in yearlyDataSorted" :key="yearData.year">
                                        <tr>
                                            <td><strong x-text="yearData.year"></strong></td>
                                            <td class="text-end" x-text="formatAmount(yearData.revenue)"></td>
                                            <td class="text-end" x-text="formatAmount(yearData.operating_income)"></td>
                                            <td class="text-end" x-text="formatAmount(yearData.net_income)"></td>
                                            <td class="text-end" x-text="formatAmount(yearData.total_assets)"></td>
                                            <td class="text-end" x-text="formatAmount(yearData.total_equity)"></td>
                                            <!-- 매출총이익률과 판관비율은 현재 사용하지 않으므로 주석 처리 -->
                                            <!-- <td class="text-end" x-text="formatPercent(yearData.gross_profit_margin)">
                                            </td> -->
                                            <!-- <td class="text-end"
                                                x-text="formatPercent(yearData.selling_admin_expense_ratio)"></td> -->
                                            <td class="text-end"
                                                x-text="formatPercent(yearData.total_assets_operating_income_ratio)">
                                            </td>
                                            <td class="text-end" x-text="formatPercent(yearData.roe)"></td>
                                            <td class="text-end" x-text="formatAmount(yearData.fcf)"></td>
                                            <td class="text-end" x-text="formatPercentFromNumber(yearData.roic)"></td>
                                            <td class="text-end" x-text="formatPercentFromNumber(yearData.wacc)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 메모 섹션 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">
                            <i class="bi bi-journal-text me-2"></i>메모
                        </h4>
                        <div class="mb-3">
                            <textarea class="form-control" rows="5" x-model="memoText"
                                placeholder="기업에 대한 메모를 입력하세요..."></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">메모는 저장하면 즉시 반영됩니다.</small>
                            <button type="button" class="btn btn-primary" @click="saveMemo()" :disabled="savingMemo">
                                <span x-show="!savingMemo">
                                    <i class="bi bi-save me-2"></i>저장
                                </span>
                                <span x-show="savingMemo">
                                    <span class="spinner-border spinner-border-sm me-2"></span>저장 중...
                                </span>
                            </button>
                        </div>
                        <div x-show="memoMessage" class="mt-3">
                            <div
                                :class="memoMessageType === 'success' ? 'alert alert-success alert-sm' : 'alert alert-danger alert-sm'">
                                <span x-text="memoMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 사업보고서 링크 -->
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-3">
                            <i class="bi bi-file-earmark-text me-2"></i>사업보고서
                        </h4>
                        <div x-show="annualReportLink">
                            <a :href="annualReportLink" target="_blank" class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right me-2"></i>
                                DART 공시시스템에서 사업보고서 보기
                            </a>
                        </div>
                        <div x-show="!annualReportLink && !loadingReportLink" class="text-muted">
                            사업보고서 링크를 불러올 수 없습니다.
                        </div>
                        <div x-show="loadingReportLink" class="text-muted">
                            <span class="loading-spinner me-2"></span>링크를 불러오는 중...
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
    function companyDetail(corpCode) {
        return {
            corpCode: corpCode,
            loading: true,
            loadingReportLink: false,
            error: null,
            companyData: null,
            annualReportLink: null,
            memoText: '',
            savingMemo: false,
            memoMessage: null,
            memoMessageType: null,

            get yearlyDataSorted() {
                if (!this.companyData || !this.companyData.yearly_data) {
                    return [];
                }
                return [...this.companyData.yearly_data].sort((a, b) => b.year - a.year);
            },

            async init() {
                await this.fetchCompanyData();
                await this.fetchAnnualReportLink();
            },

            async fetchCompanyData() {
                this.loading = true;
                this.error = null;

                try {
                    const response = await fetch(`/api/companies/${this.corpCode}/financial-data/`);
                    const data = await response.json();

                    if (response.ok) {
                        this.companyData = data;
                        this.memoText = data.memo || '';
                    } else {
                        this.error = data.error || '데이터를 불러올 수 없습니다.';
                    }
                } catch (error) {
                    this.error = '데이터를 불러오는 중 오류가 발생했습니다: ' + error.message;
                } finally {
                    this.loading = false;
                }
            },

            async fetchAnnualReportLink() {
                this.loadingReportLink = true;

                try {
                    const response = await fetch(`/api/companies/${this.corpCode}/annual-report-link/`);
                    const data = await response.json();

                    if (response.ok && data.link) {
                        this.annualReportLink = data.link;
                    }
                } catch (error) {
                    // 링크 조회 실패는 치명적이지 않으므로 에러를 표시하지 않음
                    console.error('사업보고서 링크 조회 실패:', error);
                } finally {
                    this.loadingReportLink = false;
                }
            },

            formatAmount(value) {
                if (value === null || value === undefined || value === 0) {
                    return '-';
                }

                // 억 단위로 변환
                const eok = value / 100000000;
                if (eok >= 1000) {
                    return (eok / 1000).toFixed(2) + '조';
                } else {
                    return eok.toFixed(2) + '억';
                }
            },

            formatPercent(value) {
                if (value === null || value === undefined) {
                    return '-';
                }
                return (value * 100).toFixed(2) + '%';
            },

            formatPercentFromNumber(value) {
                if (value === null || value === undefined || value === 0) {
                    return '-';
                }
                return value.toFixed(2) + '%';
            },

            // 메모 저장
            async saveMemo() {
                this.savingMemo = true;
                this.memoMessage = null;

                try {
                    const response = await fetch(`/api/companies/${this.corpCode}/memo/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({ memo: this.memoText })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.memoMessage = '메모가 저장되었습니다.';
                        this.memoMessageType = 'success';
                    } else {
                        this.memoMessage = data.error || '메모 저장에 실패했습니다.';
                        this.memoMessageType = 'error';
                    }
                } catch (error) {
                    this.memoMessage = '메모 저장 중 오류가 발생했습니다: ' + error.message;
                    this.memoMessageType = 'error';
                } finally {
                    this.savingMemo = false;
                    setTimeout(() => { this.memoMessage = null; }, 5000);
                }
            },

            // CSRF 토큰 가져오기
            getCsrfToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            }
        }
    }
</script>
{% endblock %}