# 전체 코드 검사 요약

나중에 수정 시 참고용으로 정리한 문서입니다.

---

## 1. 버그·잠재 오류

### 1) `IndicatorCalculator.calculate_icr` – 정의되지 않은 속성 참조

**파일**: `apps/service/calculator.py` (101~121행)

- `yearly_data.finance_costs`를 사용하는데, `YearlyFinancialDataObject`에는 `finance_costs`가 없고 `interest_expense`만 있음.
- docstring에 "현재 사용하지 않습니다"라고 되어 있어 실제 호출 경로는 없을 수 있으나, 호출되는 순간 `AttributeError` 가능.
- **권장**: `finance_costs`를 쓰지 않고 `interest_expense`로 통일하거나, 사용하지 않으면 해당 메서드/참조 제거.

---

### 2) `get_passed_companies` – corp_code → 종목코드 변환 비효율

**파일**: `apps/companies/views/api_misc.py` (41~47행)

- 페이지당 N개 기업마다 `get_stock_code_by_corp_code(company.corp_code)` 호출.
- `apps/service/corp_code.py`의 `get_stock_code_by_corp_code`는 매번 `DartClient._corp_code_mapping_cache` 전체를 순회(O(전체 종목 수)).
- 페이지 10개면 10번 전체 순회. 종목 수가 많을수록 느려짐.
- **권장**: `corp_code → stock_code` 역방향 캐시를 한 번만 만들고(또는 첫 역조회 시 구축) 재사용하거나, `get_passed_companies`에서 해당 페이지의 `corp_code` 리스트로 한 번에 매핑하는 함수를 두고, 그 결과를 루프에서 조회만 하도록 변경.

---

### 3) `search_companies` – `limit` 상한 없음

**파일**: `apps/companies/views/api_misc.py` (77~92행)

- `limit = int(request.GET.get("limit", 10))`만 하고 있어, `?limit=99999`처럼 큰 값을 주면 DB/응답 부하 가능.
- **권장**: `limit = min(max(1, limit), 100)` 등 상한(예: 100) 적용.

---

## 2. 비효율·개선 포인트

### 4) `save_company_to_db` – 연도별 `update_or_create` 반복

**파일**: `apps/service/db.py` (221~251행)

- `company_data.yearly_data`마다 `YearlyFinancialDataModel.objects.update_or_create(...)` 1회씩 호출.
- 연도 5개면 DB 왕복 5번. 배치 수집 시 회사당 5번 × 회사 수만큼 쿼리 발생.
- **권장**: bulk_update / bulk_create 조합으로 연도별 행을 한 번에 처리하거나, 최소한 같은 트랜잭션 안에서 배치로 처리해 네트워크/커밋 비용을 줄이는 방안 검토.

---

### 5) `load_company_from_db` – 연도별 객체 수동 매핑

**파일**: `apps/service/db.py` (148~172행)

- `yearly_data_list`를 순회하면서 필드를 하나씩 대입. 필드 추가 시 여기도 수정해야 해서 누락 위험.
- **권장**: `YearlyFinancialData` → `YearlyFinancialDataObject` 변환을 한 곳(헬퍼/메서드)으로 모으고, 필드 목록을 리스트/루프로 돌리거나 모델 메타를 활용해 자동 매핑하도록 하면 유지보수와 일관성에 유리.

---

### 6) `check_second_filter` – 매번 DB 쿼리 3건

**파일**: `apps/service/filter.py` (206~224행)

- `check_second_filter(corp_code)`가 호출될 때마다 `YearlyFinancialData`에 대해 `order_by('-year')[:3]` 쿼리 1번.
- 기업 조회 API에서 parse-paste 저장 후 `_refresh_second_filter_only`로 호출하므로, 기업 한 번 볼 때마다 1회 쿼리. 현재는 부담이 크지 않으나, 목록/대량 조회로 확장 시 쿼리 수가 늘어남.
- **권장**: "필터 통과 목록" 등에서 여러 기업의 2차 필터를 한꺼번에 갱신하는 배치 API/관리 명령을 두면, 나중에 확장 시 유리.

---

## 3. 일관성·설계

### 7) `save_company_to_db`에 `fcf` / `roic` / `wacc` 미포함

**파일**: `apps/service/db.py` (225~250행)

- `YearlyFinancialData`의 `fcf`, `roic`, `wacc`는 `defaults`에 없음.
- 배치 수집에서는 이들을 계산하지 않고, 계산기는 parse-paste에서만 채우므로, "배치 저장 시 기존(parse-paste) FCF/ROIC/WACC를 덮어쓰지 않기 위해" 의도적으로 뺀 것으로 보임. 현재 설계와 동작은 일치함.
- **참고**: 나중에 배치 수집에서도 FCF/ROIC/WACC를 계산해 저장하는 경로를 넣는다면, 그때는 `save_company_to_db`의 `defaults`에 이 필드들을 포함해야 2차 필터(ROIC–WACC)가 DB 기준으로 맞게 동작함.

---

### 8) `Company` 저장 시 `passed_second_filter` / `market_cap` 미갱신

**파일**: `apps/service/db.py` (205~220행)

- `save_company_to_db`의 Company `defaults`에는 `passed_second_filter`, `market_cap`, `market_cap_updated_at`이 없음.
- 2차 필터는 `_refresh_second_filter_only`에서, 시가총액은 KRX 조회/계산기·시가총액 API에서만 갱신. 역할 분리가 명확함.
- **결론**: 설계상 문제 없음.

---

## 4. 보안·설정

### 9) `ALLOWED_HOSTS`

**파일**: `config/settings.py` (21행)

- `ALLOWED_HOSTS = []`이면 프로덕션/실서버 배포 시 Django가 호스트 검증에서 막을 수 있음.
- **권장**: 배포 시 `DEBUG=False`와 함께 `ALLOWED_HOSTS`를 실제 도메인/호스트로 설정.

---

### 10) `SECRET_KEY`

**파일**: `config/settings.py` (16행)

- 기본값이 `'django-insecure-change-this-in-production'`으로 되어 있음.
- **권장**: 운영 환경에서는 반드시 `.env` 등으로 별도 SECRET_KEY 설정.

---

## 5. 기타

### 11) `YearlyFinancialIndicator` 모델

- 코드 구조 요약에는 "수집 시 임시 사용, DB에 저장하지 않음"이라고 되어 있음.
- 실제로 `YearlyFinancialIndicator.objects.create`/`.update`는 호출되지 않고, `yearly_indicators`는 메모리 dict로만 사용됨.
- 마이그레이션으로 테이블은 존재하지만, 현재 코드 경로에서는 비어 있을 수 있음. 기능상 문제는 없고, 나중에 "지표 이력 저장" 등을 넣을 때 활용할 수 있는 구조로 보면 됨.

---

### 12) KRX `ensure_latest_snapshot`

**파일**: `apps/service/krx_client.py`

- 시장별로 `_should_refresh_snapshot`이 하나라도 True면 유가/코스닥/코넥스 전부 다시 호출하는 구조. 의도된 동작이라면 "한 시장이라도 오래됐으면 전부 갱신"으로 이해할 수 있음.
- "저장된 bas_dd가 어제보다 이전일 때만 재수집"으로 수정해 두었다면, 불필요한 재수집은 줄어든 상태.

---

## 6. 우선순위 정리

| 우선순위 | 항목 | 위험도 | 비고 |
|----------|------|--------|------|
| 1 | calculator `finance_costs` 참조 | 중 | 호출 시 AttributeError 가능 |
| 2 | search `limit` 상한 | 중 | 과도한 조회/응답 방지 |
| 3 | get_passed_companies corp→stock 변환 | 낮음 | 목록 페이지 응답 시간 개선 |
| 4 | save_company_to_db 연도별 쿼리 | 낮음 | 배치 수집 시 DB 부하 완화 |
| 5 | ALLOWED_HOSTS / SECRET_KEY | 배포 시 필수 | 운영 환경에서만 적용 |
