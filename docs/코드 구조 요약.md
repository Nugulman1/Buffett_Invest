# 코드 구조 요약

## 프로젝트 개요
장기 투자 필터링 프로그램 - DART와 ECOS API를 활용한 재무 데이터 수집 및 분석 시스템

## 기술 스택
- **프레임워크**: Django 6.0
- **API**: Django REST Framework
- **언어**: Python 3.13
- **의존성 관리**: requirements.txt
- **환경 변수**: python-dotenv (.env 파일)

## 프로젝트 구조

```
Long_Term_Investing/
├── apps/                    # 애플리케이션 모듈
│   ├── dart/                # DART API 관련
│   │   ├── client.py        # DART API 클라이언트
│   │   ├── views.py         # DART API 뷰
│   │   ├── urls.py          # DART URL 라우팅
│   │   └── apps.py          # DART 앱 설정
│   ├── ecos/                # ECOS API 관련
│   │   ├── client.py        # ECOS API 클라이언트
│   │   ├── views.py         # ECOS API 뷰
│   │   ├── urls.py          # ECOS URL 라우팅
│   │   └── apps.py          # ECOS 앱 설정
│   ├── service/             # 데이터 수집 서비스 레이어
│   │   ├── orchestrator.py  # 데이터 수집 오케스트레이터
│   │   ├── dart.py          # DART 데이터 수집 서비스
│   │   ├── ecos.py          # ECOS 데이터 수집 서비스
│   │   └── xbrl_parser.py   # XBRL 파일 파싱 서비스
│   ├── utils/               # 유틸리티 모듈
│   │   └── utils.py         # 정규화 및 출력 유틸리티
│   └── models.py            # 데이터 모델 (공통)
├── config/                  # Django 프로젝트 설정
│   ├── settings.py          # 프로젝트 설정
│   ├── urls.py              # 메인 URL 라우팅
│   └── wsgi.py              # WSGI 설정
├── docs/                    # 문서
├── indicators_mappings.json # 재무제표 계정명 매핑 테이블
├── xbrl_acode_mappings.json # XBRL ACODE 매핑 테이블
├── manage.py                # Django 관리 스크립트
├── requirements.txt         # Python 패키지 의존성
└── .env                     # 환경 변수 (API 키 등)

```

## 주요 모듈 설명

### 1. 데이터 모델 (`apps/models.py`)

#### `FinancialStatementData`
연도별 재무제표 데이터 (O(1) 조회용 인덱싱)
- **속성**: `year`, `reprt_code`, `fs_div`
- **인덱싱**: `account_index` - 계정명을 키로 하는 딕셔너리 (CFS 우선, 중복 계정명 덮어쓰지 않음)
- **메서드**: `get_account_value()` - 계정값 O(1) 조회

#### `YearlyFinancialData`
년도별 재무 데이터 객체
- **기본 정보**: `year`, `corp_code`
- **기본 지표**: `total_assets`, `operating_income`, `net_income`, `current_liabilities`, `interest_bearing_current_liabilities`, `tangible_asset_acquisition` (XBRL), `intangible_asset_acquisition` (XBRL), `cfo` (XBRL), `interest_expense`, `beta`, `mrp`
- **계산된 지표**: `fcf`, `icr`, `roic`, `wacc`

#### `CompanyFinancialObject`
회사 재무제표 데이터 객체 (년도별 데이터 관리)
- **회사 정보**: `company_name`, `business_type_code`, `business_type_name`, `corp_code`, `bond_yield_5y` (채권수익률)
- **년도별 데이터**: `yearly_data` - `YearlyFinancialData` 객체 리스트 (최근 5년)

### 2. DART API 클라이언트 (`apps/dart/client.py`)

#### `DartClient`
DART OpenDART API 클라이언트
- **BASE_URL**: `https://opendart.fss.or.kr/api`
- **주요 메서드**:
  - `_make_request()`: 공통 API 요청 메서드 (JSON/바이너리 지원)
  - `get_company_info()`: 기업 정보 조회 (corp_code 기반)
  - `get_company_basic_info()`: 종목코드로 기업 기본 정보 조회 (corp_name, corp_code, industry_code)
  - `get_company_by_stock_code()`: 종목코드로 전체 기업 정보 조회
  - `_get_corp_code_by_stock_code()`: 종목코드로 기업 고유번호 조회 (XML 파일 파싱)
  - `get_financial_statement()`: 재무제표 조회 (BS, IS, CF 포함)
  - `get_report_list()`: 공시보고서 목록 조회 (페이지네이션 지원)
  - `download_xbrl()`: XBRL 원본 파일 다운로드
  - `get_annual_report_rcept_no()`: 사업보고서 접수번호 조회 (페이지네이션 처리)
  - `download_xbrl_and_extract_annual_report()`: XBRL 다운로드 및 사업보고서 XML 추출

### 3. ECOS API 클라이언트 (`apps/ecos/client.py`)

#### `EcosClient`
ECOS 한국은행 경제통계시스템 API 클라이언트
- **BASE_URL**: `https://ecos.bok.or.kr/api`
- **주요 메서드**:
  - `_make_request()`: 공통 API 요청 메서드 (주기별 지원)
  - `get_bond_yield_5y()`: 국채 5년 수익률 조회 (월별, 이전 달 자동 조회)

### 4. 데이터 수집 서비스 (`apps/service/`)

#### `EcosDataService` (`ecos.py`)
- `collect_bond_yield_5y()`: 국채 5년 수익률 수집

#### `DartDataService` (`dart.py`)
- `_get_recent_years()`: 최근 N년 연도 자동 계산 (연간보고서 발행 시점 고려)
- `collect_financial_data()`: 단일 연도의 연간 보고서 재무제표 데이터 수집
  - 연결재무제표(CFS) 우선, 없으면 별도재무제표(OFS) 사용
  - `FinancialStatementData` 객체 반환
- `fill_basic_indicators()`: 여러 연도의 기본 지표를 수집하여 `CompanyFinancialObject`에 채움
  - 매핑표(`indicators_mappings.json`) 활용
  - 정규화 함수를 사용한 계정명 매칭
  - 기본 지표: 자산총계, 영업이익, 유동부채, 당기순이익
- `collect_xbrl_indicators()`: XBRL 파일에서 추가 지표 수집
  - 사업보고서 접수번호 조회 및 XBRL 다운로드
  - XBRL 파싱을 통한 유형자산 취득, 무형자산 취득, CFO 수집

#### `DataOrchestrator` (`orchestrator.py`)
- `collect_company_data()`: 회사 데이터 통합 수집 (구현 완료)
  - DART 데이터 수집 (최근 5년)
  - ECOS 데이터 수집 (채권수익률 - 가장 최근 값)
  - XBRL 데이터 수집 (유형자산 취득, 무형자산 취득, CFO)
  - `CompanyFinancialObject` 객체 생성 및 채우기

## API 엔드포인트

### DART
- `GET /api/dart/company/<corp_code>/` - 기업 정보 조회

### ECOS
- (현재 테스트 코드 제거됨, 추후 추가 예정)

## 설정 파일

### `config/settings.py`
- **INSTALLED_APPS**: `rest_framework`, `apps.dart`, `apps.ecos`
- **API 키**: `.env` 파일에서 `DART_API_KEY`, `ECOS_API_KEY` 로드
- **데이터베이스**: SQLite (현재)

### `.env` 파일 (필수)
```
DART_API_KEY=your_dart_api_key
ECOS_API_KEY=your_ecos_api_key
SECRET_KEY=your_secret_key
DEBUG=True
```

## 데이터 흐름

1. **데이터 수집**: `DartClient` / `EcosClient` → API 호출
2. **서비스 레이어**: `DartDataService` / `EcosDataService` → 데이터 가공
3. **오케스트레이터**: `DataOrchestrator` → 통합 수집 및 조율
4. **모델 객체**: `CompanyFinancialObject` / `FinancialStatementData` → 데이터 저장
5. **API 응답**: Django REST Framework → JSON 응답

### 5. XBRL 파서 (`apps/service/xbrl_parser.py`)

#### `XbrlParser`
XBRL XML 파일 파싱 클래스
- **주요 메서드**:
  - `extract_annual_report_file()`: ZIP 파일에서 사업보고서 XML 추출 (문자열 검색 우선 전략)
  - `build_acode_index()`: XML 파싱을 통한 ACODE 인덱스 생성
  - `build_acode_index_from_regex()`: 정규식 기반 ACODE 인덱스 생성 (XML 파싱 실패 시 폴백)
  - `parse_xbrl_file()`: XBRL 파일 파싱 (XML 파싱 실패 시 정규식 파싱으로 자동 전환)
  - `extract_value_by_acode()`: ACODE로 특정 지표 값 추출
  - `_normalize_decimal()`: ADECIMAL 기반 단위 정규화 (XBRL 전용)
  - `filter_context()`: contextRef 필터링 (당기 연간 연결재무제표만 채택)
- **매핑 테이블**: `xbrl_acode_mappings.json` (IFRS 표준 ACODE 매핑)

### 6. 유틸리티 (`apps/utils/utils.py`)

- `normalize_account_name()`: 계정명 정규화 함수 (공백 제거, 괄호 정리)
- `format_amount_korean()`: 금액을 조, 억, 만 단위로 포맷팅
- `print_latest_year_indicators()`: 가장 최근 년도 지표 데이터 출력 (수집 확인용)

## 주요 특징

- **O(1) 조회**: `FinancialStatementData`에서 계정명으로 즉시 조회 가능
- **CFS 우선 사용**: 연결재무제표와 별도재무제표가 함께 있을 때 CFS 우선 사용
- **자동 날짜 처리**: ECOS API에서 이전 달 데이터 자동 조회
- **모듈화**: DART/ECOS 분리, 서비스 레이어 분리
- **확장성**: 새로운 데이터 소스 추가 용이
- **년도별 데이터 관리**: `CompanyFinancialObject`에서 최근 5년 데이터를 `YearlyFinancialData` 리스트로 관리
- **XBRL 파싱**: XML 파싱 실패 시 정규식 파싱으로 자동 폴백
- **페이지네이션 처리**: DART API의 모든 페이지를 순회하여 데이터 수집

