# 코드 구조 요약

## 프로젝트 개요
장기 투자 필터링 프로그램 - DART와 ECOS API를 활용한 재무 데이터 수집 및 분석 시스템

## 기술 스택
- **프레임워크**: Django 6.0
- **API**: Django REST Framework
- **언어**: Python 3.13
- **의존성 관리**: requirements.txt
- **환경 변수**: python-dotenv (.env 파일)

## 프로젝트 구조

```
Long_Term_Investing/
├── apps/                    # 애플리케이션 모듈
│   ├── dart/                # DART API 관련
│   │   ├── client.py        # DART API 클라이언트
│   │   ├── views.py         # DART API 뷰
│   │   ├── urls.py          # DART URL 라우팅
│   │   └── apps.py          # DART 앱 설정
│   ├── ecos/                # ECOS API 관련
│   │   ├── client.py        # ECOS API 클라이언트
│   │   ├── views.py         # ECOS API 뷰
│   │   ├── urls.py          # ECOS URL 라우팅
│   │   └── apps.py          # ECOS 앱 설정
│   ├── companies/           # 기업 재무 데이터 조회 프론트엔드
│   │   ├── views.py         # 기업 조회 뷰 (프론트엔드 + API)
│   │   ├── urls.py          # 기업 조회 URL 라우팅
│   │   ├── apps.py          # Companies 앱 설정
│   │   └── templates/       # Django 템플릿
│   │       ├── base.html    # 기본 템플릿
│   │       └── companies/
│   │           ├── list.html    # 기업 목록 조회 페이지
│   │           ├── detail.html # 기업 상세 정보 페이지
│   │           └── calculator.html # 재무 지표 계산기 페이지 (FCF, ROIC, WACC)
│   ├── service/             # 데이터 수집 서비스 레이어
│   │   ├── orchestrator.py  # 데이터 수집 오케스트레이터
│   │   ├── dart.py          # DART 데이터 수집 서비스
│   │   ├── ecos.py          # ECOS 데이터 수집 서비스
│   │   ├── xbrl_parser.py   # XBRL 파일 파싱 서비스
│   │   ├── calculator.py    # 재무 지표 계산 서비스
│   │   └── filter.py        # 장기 투자 필터링 서비스
│   ├── utils/               # 유틸리티 모듈
│   │   └── utils.py         # 정규화 및 출력 유틸리티
│   ├── models.py            # 데이터 모델 (공통)
│   ├── migrations/          # Django 마이그레이션
│   │   ├── 0001_initial.py  # 초기 마이그레이션
│   │   ├── 0002_bondyield_company_last_collected_at.py  # BondYield 모델 및 last_collected_at 필드 추가
│   │   └── 0003_apicallstats.py  # ApiCallStats 모델 추가 (일별 API 호출 통계)
├── config/                  # Django 프로젝트 설정
│   ├── settings.py          # 프로젝트 설정
│   ├── urls.py              # 메인 URL 라우팅
│   └── wsgi.py              # WSGI 설정
├── docs/                    # 문서
├── indicators_mappings.json # 재무제표 계정명 매핑 테이블
├── xbrl_acode_mappings.json # XBRL ACODE 매핑 테이블
├── db.sqlite3               # SQLite 데이터베이스
├── manage.py                # Django 관리 스크립트
├── collect_all_companies.py # 전체 기업 데이터 수집 스크립트
├── requirements.txt         # Python 패키지 의존성
└── .env                     # 환경 변수 (API 키 등)

```

## 주요 모듈 설명

### 1. 데이터 모델 (`apps/models.py`)

#### Django ORM 모델
- **`Company`**: 회사 정보 및 필터 결과를 저장하는 Django 모델
  - `corp_code` (PK), `company_name`, `business_type_code`, `business_type_name`
  - `bond_yield_5y` (채권수익률, 소수 형식으로 저장: 0.03057 = 3.057%)
  - `last_collected_at` (마지막 수집 일시, 4월 1일 기준으로 1년 단위 재수집 판단)
  - 필터 결과: `passed_all_filters`, `filter_operating_income`, `filter_net_income`, `filter_revenue_cagr`, `filter_total_assets_operating_income_ratio`
  - `memo` (메모, 기업 분석 내용 저장)
- **`BondYield`**: 채권수익률 모델 (단일 레코드만 유지, 하루 기준 캐싱)
  - `yield_value` (채권수익률 값, 소수 형식)
  - `collected_at` (수집 일시, 하루가 지나면 재수집)
- **`ApiCallStats`**: 일별 API 호출 통계 모델
  - `date` (PK, 날짜)
  - `dart_calls` (DART API 호출 횟수, 일별 누적)
  - `ecos_calls` (ECOS API 호출 횟수, 일별 누적)
  - 같은 날짜에 여러 번 실행해도 기존 값에 누적 저장
- **`YearlyFinancialData`**: 년도별 재무 데이터를 저장하는 Django 모델
  - `company` (ForeignKey), `year`
  - 기본 지표: `revenue`, `operating_income`, `net_income`, `total_assets`, `total_equity`
  - 재무 지표 (소수 형식으로 저장: 0.30335 = 30.335%, 프론트엔드에서 *100하여 표시):
    - `gross_profit_margin` (매출총이익률) - **사용 안 함** (API 호출 제거로 수집하지 않음)
    - `selling_admin_expense_ratio` (판관비율) - **사용 안 함** (API 호출 제거로 수집하지 않음)
    - `total_assets_operating_income_ratio` (총자산영업이익률) - 계산 방식 (영업이익/자산총계)
    - `roe` (ROE) - 계산 방식 (당기순이익/자본총계)
  - 계산 지표 (계산기에서 입력하여 저장):
    - `fcf` (자유현금흐름)
    - `roic` (투하자본수익률, % 단위)
    - `wacc` (가중평균자본비용, % 단위)

#### Python 데이터 클래스 (하위 호환성 유지)

#### `FinancialStatementData`
연도별 재무제표 데이터 (O(1) 조회용 인덱싱)
- **속성**: `year`, `reprt_code`, `fs_div`
- **인덱싱**: `account_index` - 계정명을 키로 하는 딕셔너리 (CFS 우선, 중복 계정명 덮어쓰지 않음)
- **메서드**: `get_account_value()` - 계정값 O(1) 조회

#### `YearlyFinancialData`
년도별 재무 데이터 객체
- **기본 정보**: `year`, `corp_code`
- **기본 지표 (DART API)**: 
  - `revenue` (매출액), `operating_income` (영업이익), `net_income` (당기순이익)
  - `total_assets` (자산총계), `total_equity` (자본총계)
  - `gross_profit_margin` (매출총이익률) - **사용 안 함** (API 호출 제거)
  - `selling_admin_expense_ratio` (판관비율) - **사용 안 함** (API 호출 제거)
  - `total_assets_operating_income_ratio` (총자산영업이익률) - 계산 방식 (영업이익/자산총계)
  - `roe` (ROE) - 계산 방식 (당기순이익/자본총계)
- **계산에 사용하는 기본 지표 (계산기에서 입력)**: 
  - `tangible_asset_acquisition` (유형자산 취득), `intangible_asset_acquisition` (무형자산 취득)
  - `cfo` (영업활동현금흐름), `equity` (자기자본), `cash_and_cash_equivalents` (현금및현금성자산)
  - `short_term_borrowings` (단기차입금), `current_portion_of_long_term_borrowings` (유동성장기차입금)
  - `long_term_borrowings` (장기차입금), `bonds` (사채), `lease_liabilities` (리스부채)
  - `convertible_bonds` (전환부채), `interest_expense` (이자비용, WACC 계산에 사용)
  - 고정값: `beta` (1.0), `mrp` (5.0)
- **계산된 지표**: 계산기에서 입력한 데이터를 기반으로 계산하여 DB에 저장
  - `fcf` (자유현금흐름), `roic` (투하자본수익률), `wacc` (가중평균자본비용)
  - `icr` (이자보상비율) - 계산은 되지만 DB에는 저장하지 않음

#### `CompanyFinancialObject`
회사 재무제표 데이터 객체 (년도별 데이터 관리)
- **회사 정보**: `company_name`, `business_type_code`, `business_type_name`, `corp_code`, `bond_yield_5y` (채권수익률)
- **년도별 데이터**: `yearly_data` - `YearlyFinancialData` 객체 리스트 (최근 5년)
- **필터 결과**: 
  - `passed_all_filters` (전체 필터 통과 여부)
  - `filter_operating_income`, `filter_net_income`, `filter_revenue_cagr`, `filter_total_assets_operating_income_ratio` (개별 필터 통과 여부)

### 2. DART API 클라이언트 (`apps/dart/client.py`)

#### `DartClient`
DART OpenDART API 클라이언트
- **BASE_URL**: `https://opendart.fss.or.kr/api`
- **클래스 변수**: 
  - `_corp_code_mapping_cache` (종목코드 → corp_code 매핑 캐시)
  - `_api_call_count` (API 호출 횟수 추적)
  - `_last_stats_update_date` (일별 통계 업데이트 날짜)
  - `_pending_dart_calls` (대기 중인 API 호출 횟수, 배치 업데이트용)
- **주요 메서드**:
  - `_make_request()`: 공통 API 요청 메서드 (JSON/바이너리 지원, 재시도 로직 포함, API 호출 사이 지연 적용)
    - API 호출 후 `settings.DATA_COLLECTION['API_DELAY']` 초만큼 지연 (Rate Limiting 방지)
    - 일별 통계 자동 업데이트 (`_update_daily_stats()` 호출)
  - `_update_daily_stats()`: 일별 API 호출 통계 업데이트 (배치 처리, 10회마다 DB 저장)
  - `flush_daily_stats()`: 프로그램 종료 시 대기 중인 통계를 DB에 저장
  - `load_corp_code_xml()`: corpCode.xml 파일 다운로드 및 캐시 로드 (최초 1회, `_make_request()` 사용하여 재시도 로직 적용)
  - `get_company_info()`: 기업 정보 조회 (corp_code 기반)
  - `get_company_basic_info()`: 종목코드로 기업 기본 정보 조회 (corp_name, corp_code, industry_code)
  - `get_company_by_stock_code()`: 종목코드로 전체 기업 정보 조회
  - `_get_corp_code_by_stock_code()`: 종목코드로 기업 고유번호 조회 (캐시된 XML 매핑 사용)
  - `get_financial_statement()`: 재무제표 조회 (원시 금액 데이터, BS, IS 포함)
  - `get_financial_indicators()`: 재무지표 조회 (계산된 비율 지표, 매출총이익률, ROE 등)
  - `get_report_list()`: 공시보고서 목록 조회 (페이지네이션 지원)
  - `download_xbrl()`: XBRL 원본 파일 다운로드
  - `get_annual_report_rcept_no()`: 사업보고서 접수번호 조회 (페이지네이션 처리)
  - `download_xbrl_and_extract_annual_report()`: XBRL 다운로드 및 사업보고서 XML 추출

### 3. ECOS API 클라이언트 (`apps/ecos/client.py`)

#### `EcosClient`
ECOS 한국은행 경제통계시스템 API 클라이언트
- **BASE_URL**: `https://ecos.bok.or.kr/api`
- **클래스 변수**:
  - `_api_call_count` (API 호출 횟수 추적)
  - `_last_stats_update_date` (일별 통계 업데이트 날짜)
  - `_pending_ecos_calls` (대기 중인 API 호출 횟수, 배치 업데이트용)
- **주요 메서드**:
  - `_make_request()`: 공통 API 요청 메서드 (주기별 지원, API 호출 사이 지연 적용)
    - API 호출 후 `settings.DATA_COLLECTION['API_DELAY']` 초만큼 지연 (Rate Limiting 방지)
    - 일별 통계 자동 업데이트 (`_update_daily_stats()` 호출)
  - `_update_daily_stats()`: 일별 API 호출 통계 업데이트 (배치 처리, 10회마다 DB 저장)
  - `flush_daily_stats()`: 프로그램 종료 시 대기 중인 통계를 DB에 저장
  - `get_bond_yield_5y()`: 국채 5년 수익률 조회 (월별, 이전 달 자동 조회)

### 4. 데이터 수집 서비스 (`apps/service/`)

#### `EcosDataService` (`ecos.py`)
- `collect_bond_yield_5y()`: 국채 5년 수익률 수집

#### `DartDataService` (`dart.py`)
- `_get_recent_years()`: 최근 N년 연도 자동 계산 (연간보고서 발행 시점 고려)
- `collect_financial_data()`: 단일 연도의 연간 보고서 재무제표 데이터 수집
  - 연결재무제표(CFS) 우선, 없으면 별도재무제표(OFS) 사용
  - `FinancialStatementData` 객체 반환
- `fill_basic_indicators()`: 여러 연도의 기본 지표를 수집하여 `CompanyFinancialObject`에 채움
  - 매핑표(`indicators_mappings.json`) 활용
  - 정규화 함수를 사용한 계정명 매칭
  - 기본 지표: 매출액, 영업이익, 당기순이익, 자산총계, 자본총계, 유동부채
- ~~`fill_financial_indicators()`~~: **제거됨** - 재무지표 계산 로직이 `IndicatorCalculator.calculate_basic_financial_ratios()`로 이동
  - 매출총이익률, 판관비율: 기본 지표 API에 해당 계정이 없어서 수집하지 않음
  - 총자산영업이익률, ROE: 기본 지표에서 계산 방식으로 변경 (API 호출 제거)
- `collect_xbrl_indicators()`: **주석 처리됨 (사용하지 않음)** - XBRL 데이터 수집이 중단됨
  - 표본이 너무 적어서 데이터화를 못할듯하여 일단 중단
  - 사업보고서 접수번호 조회 및 XBRL 다운로드 기능은 있으나 현재 호출되지 않음

#### `DataOrchestrator` (`orchestrator.py`)
- `collect_company_data()`: 회사 데이터 통합 수집
  - DART 기본 지표 수집 (최근 5년)
  - 기본 재무지표 계산 (`IndicatorCalculator.calculate_basic_financial_ratios()`)
    - 총자산영업이익률, ROE는 계산 방식 (API 호출 제거로 최적화)
  - ECOS 데이터 수집 (채권수익률 - BondYield 모델 사용, 하루 기준 캐싱)
    - DB에 저장된 채권수익률이 하루가 지나지 않으면 재사용
    - 하루가 지났거나 데이터가 없으면 ECOS API 호출하여 업데이트
  - XBRL 데이터 수집: **주석 처리됨 (사용하지 않음)** - 표본이 너무 적어서 데이터화를 못할듯하여 일단 중단
  - `CompanyFinancialObject` 객체 생성 및 채우기
  - 계산 지표 자동 계산: **주석 처리됨 (사용하지 않음)** - XBRL 데이터 수집 중단으로 인해 `IndicatorCalculator.calculate_all_indicators()` 호출은 되지만 내부 로직이 모두 주석 처리됨
  - 필터 적용 (`CompanyFilter.apply_all_filters()` 통합)
  - DB 저장 로직 (`_save_to_db()` 메서드로 자동 저장)
    - `Company` 모델: 회사 정보 및 필터 결과 저장/업데이트, `last_collected_at` 필드 업데이트
    - `BondYield` 모델: 채권수익률 저장/업데이트 (단일 레코드만 유지)
    - `YearlyFinancialData` 모델: 년도별 재무 데이터 저장/업데이트

#### `IndicatorCalculator` (`calculator.py`)
- 재무 지표 계산 서비스
- `calculate_cagr()`: CAGR (연평균 성장률) 계산 (필터링에 사용)
  - 공식: `(end_value / start_value)^(1/years) - 1`
- `calculate_total_assets_operating_income_ratio()`: 총자산영업이익률 계산 (영업이익/자산총계)
- `calculate_roe()`: ROE 계산 (당기순이익/자본총계)
- `calculate_basic_financial_ratios()`: 기본 재무지표 계산 (총자산영업이익률, ROE)
  - API 호출 최적화를 위해 재무지표 API 호출을 제거하고 계산 방식으로 변경
  - 소수 형태로 저장 (프론트엔드에서 *100하여 백분율로 표시)
- `calculate_fcf()`: 자유현금흐름 계산 (CFO - 유형자산 취득 - 무형자산 취득)
- `calculate_icr()`: 이자보상비율 계산 (영업이익 / 금융비용, 현재 사용하지 않음)
- `calculate_roic()`: 투하자본수익률 계산 (영업이익 × (1 - 법인세율) / (자기자본 + 이자부채))
  - 이자부채 = 단기차입금 + 유동성장기차입금 + 장기차입금 + 사채 + 리스부채 + 전환부채
- `calculate_wacc()`: 가중평균자본비용 계산
  - Rd = 이자비용 / 이자부채
  - WACC = (E / (E + D)) × Re + (D / (E + D)) × Rd × (1 - 법인세율)

## 관리 명령어

### `collect_all_companies.py`
전체 기업 데이터 수집 스크립트
- **파일**: 프로젝트 루트의 `collect_all_companies.py`
- **사용법**: `python collect_all_companies.py [--limit N] [--max-workers N]`
- **기능**:
  - `종목코드.md` 파일에서 종목코드 읽기
  - `should_collect_company()` 함수를 사용하여 수집 필요 여부 확인 (4월 1일 기준)
  - 각 종목코드에 대해:
    - 종목코드 → corp_code 변환 (XML 캐시 사용)
    - `should_collect_company()` 함수로 수집 필요 여부 확인
    - 병렬 처리로 `DataOrchestrator.collect_company_data()` 호출하여 데이터 수집
    - 필터 통과 기업은 `passed_filters_stock_codes.txt`에 저장
- **옵션**:
  - `--limit`: 수집할 최대 기업 수 (기본값: 설정 파일에서 가져옴)
  - `--max-workers`: 병렬 처리 스레드 수 (기본값: 설정 파일에서 가져옴)
- **생성 파일**:
  - `passed_filters_stock_codes.txt`: 필터 통과 기업 종목코드 목록
- **특징**:
  - 병렬 처리 지원 (ThreadPoolExecutor 사용)
  - DB를 Single Source of Truth로 사용 (파일 기반 추적 제거)
  - 데이터 수집은 병렬 처리, DB 저장은 순차 처리 (SQLite 동시성 문제 해결)
  - 상세 통계 출력: 전체 처리 시간, 기업당 평균 처리 시간, API 호출 횟수 (이번 실행 + 일별 누적)
  - 일별 API 호출 통계 자동 저장 및 출력 (`ApiCallStats` 모델 사용)
  - 프로그램 종료 시 대기 중인 통계 자동 저장 (`flush_daily_stats()` 호출)
  - KeyboardInterrupt 처리 (Ctrl+C로 안전하게 종료 가능)

## API 엔드포인트

### DART
- `GET /api/dart/company/<corp_code>/` - 기업 정보 조회

### ECOS
- (현재 테스트 코드 제거됨, 추후 추가 예정)

### Companies (기업 재무 데이터 조회)
- `GET /companies/` - 기업 조회 페이지 (프론트엔드, 단일 기업 검색)
  - 기업번호(8자리) 또는 종목코드(6자리) 입력 시 해당 기업 상세 페이지로 이동
- `GET /companies/calculator/` - 재무 지표 계산기 페이지 (프론트엔드, FCF/ROIC/WACC)
  - 단일 페이지에서 모든 입력 필드 제공
  - 년도 입력 필드 포함
  - 계산 결과를 DB에 저장하는 기능 제공
- `GET /companies/<corp_code>/` - 기업 상세 정보 페이지 (프론트엔드)
  - 회사 기본 정보 및 필터 결과
  - 메모 작성 및 저장 기능
  - 최근 5년 재무 지표 테이블 (FCF, ROIC, WACC 포함)
  - 사업보고서 링크
- `GET /api/companies/<corp_code>/financial-data/` - 기업 재무 데이터 조회 API
  - DB에 데이터가 있으면 DB에서 반환 (prefetch_related로 N+1 쿼리 최적화)
  - DB에 없으면 실시간 수집 후 반환 및 DB 저장
  - 응답에 `memo`, `fcf`, `roic`, `wacc` 포함
  - 종목코드(6자리) 또는 기업번호(8자리) 모두 지원 (자동 변환)
- `POST /api/companies/batch/` - 여러 기업의 재무 데이터 일괄 조회
  - 종목코드(6자리) 또는 기업번호(8자리) 모두 지원
  - 종목코드는 자동으로 기업번호로 변환
  - DB 우선 조회, 없으면 실시간 수집
- `GET /api/companies/<corp_code>/annual-report-link/` - 사업보고서 링크 조회 API
  - DART 공시시스템 링크 생성
  - 종목코드(6자리) 또는 기업번호(8자리) 모두 지원 (자동 변환)
- `POST /api/companies/<corp_code>/memo/` - 기업 메모 저장 API
  - 종목코드(6자리) 또는 기업번호(8자리) 모두 지원 (자동 변환)
- `POST /api/companies/<corp_code>/calculated-indicators/` - 계산 지표 저장 API
  - FCF, ROIC, WACC 계산 결과 및 입력 데이터 저장
  - 종목코드(6자리) 또는 기업번호(8자리) 모두 지원 (자동 변환)

## 설정 파일

### `config/settings.py`
- **INSTALLED_APPS**: `rest_framework`, `apps`, `apps.dart`, `apps.ecos`, `apps.companies`
- **API 키**: `.env` 파일에서 `DART_API_KEY`, `ECOS_API_KEY` 로드
- **데이터베이스**: SQLite (현재)
- **템플릿**: Django 템플릿 엔진 사용
- **DATA_COLLECTION 설정**:
  - `API_DELAY`: API 호출 사이 지연 시간 (초, 기본값: 1.0초, Rate Limiting 방지)

### `.env` 파일 (필수)
```
DART_API_KEY=your_dart_api_key
ECOS_API_KEY=your_ecos_api_key
SECRET_KEY=your_secret_key
DEBUG=True
```

## 데이터 흐름

1. **데이터 수집**: `DartClient` / `EcosClient` → API 호출
2. **서비스 레이어**: `DartDataService` / `EcosDataService` → 데이터 가공 (백분율을 소수로 변환)
3. **오케스트레이터**: `DataOrchestrator` → 통합 수집 및 조율
4. **모델 객체**: `CompanyFinancialObject` / `FinancialStatementData` → 데이터 저장
5. **DB 저장**: `DataOrchestrator._save_to_db()` → Django ORM 모델로 변환하여 DB 저장
6. **API 응답**: Django REST Framework → JSON 응답
7. **프론트엔드**: Django 템플릿 + Alpine.js → 사용자 인터페이스

### 5. XBRL 파서 (`apps/service/xbrl_parser.py`)

#### `XbrlParser`
XBRL XML 파일 파싱 클래스 (**현재 사용하지 않음** - 코드는 유지되어 있으나 호출되지 않음)
- **상태**: XBRL 데이터 수집이 중단되어 현재는 사용하지 않음 (표본이 너무 적어서 데이터화를 못할듯하여 일단 중단)
- **주요 메서드** (코드는 존재하나 호출되지 않음):
  - `extract_annual_report_file()`: ZIP 파일에서 사업보고서 XML 추출 (문자열 검색 우선 전략)
  - `build_acode_index_from_regex()`: 정규식 기반 ACODE 인덱스 생성 (O(1) 조회 최적화)
  - `parse_xbrl_file()`: XBRL 파일 파싱 (정규식 파싱 사용)
  - `extract_value_by_acode()`: ACODE로 특정 지표 값 추출 (O(1) 조회)
  - `_normalize_decimal()`: ADECIMAL 기반 단위 정규화 (XBRL 전용)
  - `filter_context()`: contextRef 필터링 (당기 연간 연결재무제표만 채택, CFY 패턴 사용)
- **매핑 테이블**: `xbrl_acode_mappings.json` (IFRS 표준 ACODE 매핑, 현재 사용하지 않음)

### 6. 필터링 서비스 (`apps/service/filter.py`)

#### `CompanyFilter`
장기 투자 필터링 서비스
- **필터 조건**:
  - `filter_operating_income()`: 영업이익 필터 (수집된 데이터로 계산, 5년 미만이어도 계산)
  - 영업이익 ≤ 0 인 연도 ≤ 1회
- `filter_net_income()`: 당기순이익 필터 (수집된 데이터로 계산, 5년 미만이어도 계산)
  - 당기순이익 합계 > 0
- `filter_revenue_cagr()`: 매출액 CAGR 필터 (최소 2년 데이터 필요)
  - CAGR ≥ 0%
- `filter_total_assets_operating_income_ratio()`: 총자산영업이익률 필터 (수집된 데이터로 계산, 5년 미만이어도 계산)
  - 평균 > 0
- `apply_all_filters()`: 모든 필터를 적용하고 결과를 `CompanyFinancialObject`에 저장
  - 하나라도 false면 `passed_all_filters = False`

### 7. 유틸리티 (`apps/utils/utils.py`)

- `normalize_account_name()`: 계정명 정규화 함수 (공백 제거, 괄호 정리, 영어 소문자 변환)
- `normalize_acode()`: ACODE 정규화 함수 (콜론을 언더스코어로 변환, 영어 소문자 변환)
  - XBRL ACODE 매칭을 위한 전처리
  - 예: "ifrs-full:CurrentPortionOfLongTermBorrowings" → "ifrs-full_currentportionoflongtermborrowings"
- `format_amount_korean()`: 금액을 조, 억, 만 단위로 포맷팅
- `print_latest_year_indicators()`: 가장 최근 년도 지표 데이터 출력 (수집 확인용)
  - 모든 기본 지표 및 계산된 지표 출력
  - 한국어 금액 포맷팅 지원
- `is_financial_industry()`: KSIC 코드를 기반으로 금융업 여부 판단
  - 금융업인 경우 매출액 CAGR 필터 자동 통과
- `should_collect_company()`: 기업 수집 필요 여부 확인 (4월 1일 기준)
  - DB에 기업이 없거나, last_collected_at이 없거나, 4월 1일 기준으로 1년이 지났으면 수집 필요
  - 프론트엔드 및 배치 수집 스크립트에서 공통으로 사용

### 8. 프론트엔드 (`apps/companies/`)

#### `CompaniesViews` (`views.py`)
- `company_list()`: 기업 목록 조회 페이지 (메인 페이지)
- `calculator()`: 재무 지표 계산기 페이지 (FCF, ROIC, WACC)
- `company_detail()`: 기업 상세 정보 페이지
- `get_financial_data()`: 기업 재무 데이터 조회 API
  - DB 우선 조회 (데이터가 최신이면), 없거나 오래되었으면 실시간 수집
  - `should_collect_company()` 함수를 사용하여 4월 1일 기준으로 데이터 최신성 확인
- `batch_get_financial_data()`: 여러 기업 일괄 조회 API
  - 종목코드/기업번호 자동 변환 지원
- `get_annual_report_link()`: 사업보고서 링크 생성 API

#### 템플릿
- **`base.html`**: 기본 템플릿 (Bootstrap 5 + Alpine.js)
  - 네비게이션 바에 계산기 링크 포함
- **`list.html`**: 기업 조회 페이지
  - 기업번호(8자리) 또는 종목코드(6자리) 단일 입력
  - 입력 시 해당 기업 상세 페이지로 이동
- **`detail.html`**: 기업 상세 정보 페이지
  - 회사 기본 정보
  - 필터 결과 시각화
  - 메모 작성 및 저장 기능
  - 최근 5년 재무 지표 테이블 (FCF, ROIC, WACC 포함)
  - 사업보고서 링크 (DART 공시시스템)
- **`calculator.html`**: 재무 지표 계산기 페이지
  - 단일 페이지에서 FCF, ROIC, WACC 계산기 제공
  - 년도 입력 필드 포함
  - 사용자가 사업보고서에서 직접 수치 입력
  - 천 단위 구분자(쉼표) 자동 포맷팅
  - 실시간 계산 (Alpine.js)
  - 기업코드 입력 필드 포함
  - 계산 결과를 DB에 저장하는 기능 제공

## 주요 특징

- **O(1) 조회**: `FinancialStatementData`에서 계정명으로 즉시 조회 가능
- **CFS 우선 사용**: 연결재무제표와 별도재무제표가 함께 있을 때 CFS 우선 사용
- **자동 날짜 처리**: ECOS API에서 이전 달 데이터 자동 조회
- **모듈화**: DART/ECOS 분리, 서비스 레이어 분리
- **확장성**: 새로운 데이터 소스 추가 용이
- **년도별 데이터 관리**: `CompanyFinancialObject`에서 최근 5년 데이터를 `YearlyFinancialData` 리스트로 관리
- **컨텍스트 필터링**: dFY (기간) 및 eFY (시점) 모두 지원하여 재무제표 전체 항목 수집 가능
- **페이지네이션 처리**: DART API의 모든 페이지를 순회하여 데이터 수집
- **XBRL 데이터 수집 중단**: 표본이 너무 적어서 데이터화를 못할듯하여 XBRL 데이터 수집 및 계산 지표 계산이 중단됨
- **필터링 시스템**: 4가지 필터 조건으로 장기 투자 대상 기업 선별
- **CAGR 계산**: 매출액 성장률 평가를 위한 CAGR 계산 기능
- **DB 저장**: Django ORM을 통한 영구 저장 (SQLite)
- **백분율 변환**: API에서 받은 백분율 값을 소수로 변환하여 저장 (예: 3.057% → 0.03057)
- **프론트엔드**: Django 템플릿 + Bootstrap 5 + Alpine.js로 구현된 웹 인터페이스
- **종목코드 지원**: 종목코드(6자리) 입력 시 자동으로 기업번호로 변환
- **DB 우선 조회**: DB에 데이터가 있고 최신이면 즉시 반환, 없거나 오래되었으면 실시간 수집 (4월 1일 기준)
- **XML 캐싱**: DART corpCode.xml 파일을 한 번만 다운로드하여 종목코드 → corp_code 매핑 캐싱 (`_make_request()` 사용하여 재시도 로직 적용)
- **채권수익률 캐싱**: BondYield 모델을 통해 하루 기준으로 채권수익률 데이터 캐싱
- **수집 일시 관리**: Company 모델의 last_collected_at 필드를 통해 4월 1일 기준으로 1년 단위 재수집 판단
- **대량 수집 기능**: 프로젝트 루트의 `collect_all_companies.py` 스크립트를 통한 전체 기업 데이터 자동 수집
- **N+1 쿼리 최적화**: prefetch_related를 사용하여 연관 데이터 조회 최적화
- **API 호출 최적화**: 재무지표 API 호출을 제거하고 계산 방식으로 변경 (기업당 API 호출 50% 감소)
- **일별 API 호출 통계**: `ApiCallStats` 모델을 통한 일별 API 호출 횟수 추적 및 저장 (같은 날짜에 여러 번 실행해도 누적)
- **API Rate Limiting 방지**: API 호출 사이 자동 지연 (`API_DELAY` 설정, 기본값: 1초)
- **배치 통계 업데이트**: 일별 통계는 10회마다 DB에 저장하여 성능 최적화
- **ConnectionResetError 처리**: `load_corp_code_xml()`에서 `_make_request()` 사용하여 재시도 로직 적용
- **재무 지표 계산기**: 프론트엔드에서 FCF, ROIC, WACC를 직접 계산할 수 있는 계산기 제공
  - 백엔드 계산 로직과 동일한 공식 사용
  - 천 단위 구분자 자동 포맷팅
  - 실시간 계산 및 결과 표시
  - 계산 결과를 DB에 저장하는 기능 제공
- **메모 기능**: 기업별 메모 작성 및 저장 기능 제공
- **계산 지표 저장**: 계산기에서 입력한 데이터와 계산 결과(FCF, ROIC, WACC)를 DB에 저장
- **단일 기업 조회**: 기업 조회를 단일 검색으로 변경하여 즉시 상세 페이지로 이동

