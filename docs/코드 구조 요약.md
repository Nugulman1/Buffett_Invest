# 코드 구조 요약

## 프로젝트 개요
장기 투자 필터링 프로그램 - DART와 ECOS API를 활용한 재무 데이터 수집 및 분석 시스템

## 기술 스택
- **프레임워크**: Django 6.0.x
- **API**: Django REST Framework 3.16.x
- **언어**: Python 3.12–3.14 (권장: 3.13)
- **의존성 관리**: requirements.txt
- **환경 변수**: python-dotenv 1.2.x (.env 파일)

## 프로젝트 구조

```
Long_Term_Investing/
├── apps/                    # 애플리케이션 모듈
│   ├── dart/                # DART API 관련
│   │   ├── client.py        # DART API 클라이언트
│   │   ├── views.py         # DART API 뷰
│   │   ├── urls.py          # DART URL 라우팅
│   │   └── apps.py          # DART 앱 설정
│   ├── ecos/                # ECOS API 관련
│   │   ├── client.py        # ECOS API 클라이언트
│   │   ├── views.py         # ECOS API 뷰
│   │   ├── urls.py          # ECOS URL 라우팅
│   │   └── apps.py          # ECOS 앱 설정
│   ├── companies/           # 기업 재무 데이터 조회 프론트엔드
│   │   ├── views/           # 뷰 패키지 (페이지 + API)
│   │   │   ├── pages.py     # 페이지 뷰 (목록, 상세, 계산기)
│   │   │   ├── api_financial.py   # 재무/계산기/분기/메모 API
│   │   │   ├── api_favorites.py   # 즐겨찾기 API
│   │   │   ├── api_misc.py        # 검색, 필터 통과 목록 등 API
│   │   │   └── __init__.py
│   │   ├── urls.py          # 기업 조회 URL 라우팅
│   │   ├── apps.py          # Companies 앱 설정
│   │   └── templates/       # Django 템플릿
│   │       ├── base.html    # 기본 템플릿
│   │       └── companies/
│   │           ├── list.html    # 기업 목록 조회 페이지
│   │           ├── detail.html # 기업 상세 정보 페이지
│   │           └── calculator.html # 재무 지표 계산기 페이지 (FCF, ROIC, WACC)
│   ├── service/             # 데이터 수집·DB·유틸 서비스 레이어
│   │   ├── orchestrator.py  # 데이터 수집 오케스트레이터
│   │   ├── dart.py          # DART 데이터 수집 서비스
│   │   ├── ecos.py          # ECOS 데이터 수집 서비스
│   │   ├── db.py            # DB 레이어 (연간/분기 저장·조회, 수집 여부 판단)
│   │   ├── corp_code.py     # 기업번호/종목코드 변환 (DartClient)
│   │   ├── bond_yield.py    # 국채 5년 수익률 조회 (BondYield)
│   │   ├── passed_json.py   # 필터 통과 기업 JSON 파일 읽기/쓰기
│   │   ├── memo.py          # 기업 메모 백업/복원
│   │   ├── calculator.py    # 재무 지표 계산 서비스
│   │   ├── paste_parser.py # 복붙 재무제표 파서 (연결 재무상태표/현금흐름표 텍스트 → FCF/ROIC/WACC용 계정 추출)
│   │   └── filter.py        # 장기 투자 필터링 서비스
│   ├── utils/               # 순수 유틸 (stdlib만, 의존성 없음)
│   │   ├── normalize.py     # 계정명 정규화
│   │   ├── format_.py       # 금액 포맷팅 (조/억/만)
│   │   ├── classify.py      # 기업 규모 분류
│   │   └── __init__.py      # re-export
│   ├── xbrl/                # XBRL 관련 (비활성·보관)
│   │   ├── parser.py        # XBRL 파서
│   │   ├── disabled.py      # (비활성) ACODE 추출 코드
│   │   ├── download.py      # XBRL 다운로드
│   │   ├── extract.py       # 사업보고서 XML 추출
│   │   ├── acode_utils.py   # ACODE 정규화 등
│   │   └── xbrl_acode_mappings.json
│   ├── models.py            # 데이터 모델 (공통)
│   ├── migrations/          # Django 마이그레이션 (0001–0013 squash 후 정리)
│   │   ├── 0001_initial.py  # 초기 마이그레이션 (squashed)
│   │   └── 0002_remove_company_bond_yield_5y_and_more.py
├── config/                  # Django 프로젝트 설정
│   ├── settings.py          # 프로젝트 설정
│   ├── urls.py              # 메인 URL 라우팅
│   └── wsgi.py              # WSGI 설정
├── docs/                    # 문서
├── indicators_mappings.json # 재무제표 계정명 매핑 테이블
├── db.sqlite3               # SQLite 데이터베이스
├── manage.py                # Django 관리 스크립트
├── collect_all_companies.py # 전체 기업 데이터 수집 스크립트
├── requirements.txt         # Python 패키지 의존성
└── .env                     # 환경 변수 (API 키 등)

```

## 주요 모듈 설명

### 1. 데이터 모델 (`apps/models.py`)

- **ORM 모델**: `Company` (corp_code PK, 필터 결과, 메모, last_collected_at), `BondYield` (단일 행, 하루 캐시), `ApiCallStats` (일별 호출 통계), `YearlyFinancialData` (연도별 재무, company+year unique), `QuarterlyFinancialData` (분기별, company+year+quarter unique), `FavoriteGroup`, `Favorite` (group-company unique).
- 연간/분기 데이터는 Python 객체(`FinancialStatementData`, `CompanyFinancialObject` 등)로 가공 후 ORM 저장.

### 2. DART API 클라이언트 (`apps/dart/client.py`)

- OpenDART API 클라이언트. 기업 정보·재무제표 조회, 종목코드→corp_code 매핑(corpCode.xml 캐시), 일별 호출 통계·재시도·API_DELAY 적용.

### 3. ECOS API 클라이언트 (`apps/ecos/client.py`)

- 한국은행 ECOS API 클라이언트. 국채 5년 수익률 조회(월별), 특정 날짜 이후 분기보고서 목록 조회. 일별 통계·API_DELAY 적용.

### 4. 데이터 수집 서비스 (`apps/service/`)

- **DataOrchestrator**: DART 기본 지표 수집(최근 5년) → 재무지표 계산(영업이익률, ROE) → ECOS 채권수익률(BondYield 캐시) → 필터 적용 → DB 저장.
- **DartDataService**: 연간/분기 재무제표 수집, 기본 지표 채우기(매핑표·정규화). CFS 우선, 분기 병렬(ThreadPoolExecutor).
- **EcosDataService**: 국채 5년 수익률 수집.
- **IndicatorCalculator**: CAGR, 영업이익률·ROE, FCF, ROIC, WACC 계산. 비율은 소수 저장(0.10=10%), UI에서만 *100.
- **CompanyFilter**: 5가지 필터(영업이익, 당기순이익, 매출액 CAGR≥10%, 영업이익률≥10%, ROE 규모별) + `apply_all_filters()`.

## 관리 명령어

- **`collect_all_companies.py`**: `종목코드.md`에서 종목코드 읽기 → 수집 필요 여부(4월 1일 기준) 확인 → 병렬로 `DataOrchestrator.collect_company_data()` 호출 → 필터 통과 기업은 `passed_filters_companies.json` 저장. `--limit`, `--max-workers` 옵션.
- **`backup_memos`**: 메모가 있는 기업 메모를 JSON 백업 (`python manage.py backup_memos [--output 파일명]`).
- **`restore_memos`**: JSON 백업에서 메모 복원 (`python manage.py restore_memos <파일> [--confirm]`).
- **`clear_financial_data`**: 재무 기본 필드만 초기화(FCF/ROIC/WACC·메모 보존), 분기 삭제, 재수집 가능 (`[--confirm]`, `--corp-code` 지원).
- **`migrate_passed_txt_to_json`**: txt 필터 통과 목록 → JSON 변환 (일회성).

## API 엔드포인트

- **페이지**: `/companies/` (목록·검색), `/companies/calculator/` (FCF/ROIC/WACC 계산기), `/companies/<corp_code>/` (상세).
- **재무·계산기·분기·메모**: `/api/companies/<corp_code>/financial-data/`, `calculator-data/`, `parse-paste/`(POST, 복붙 재무제표 파싱·FCF/ROIC/WACC 계산·저장), `quarterly-data/`, `memo/`, `calculated-indicators/`, `quarterly-reports/collect/`, `annual-report-link/`.
- **즐겨찾기·그룹**: `/api/companies/favorites/`, `favorite-groups/`, `<corp_code>/favorites/` 등 CRUD.
- **기타**: `/api/companies/passed/` (필터 통과 목록, 페이지네이션), `/api/companies/search/` (기업명 검색).
- **DART**: `GET /api/dart/company/<corp_code>/` — 기업 정보 조회.
- 상세 경로·메서드·파라미터는 `config/urls.py` 및 `apps/companies/views` 참고.

## 설정 파일

- **config/settings.py**: INSTALLED_APPS(rest_framework, apps, dart, ecos, companies), DB(SQLite, 타임아웃 30초), API 키(.env), DATA_COLLECTION(API_DELAY, LOGGING_LEVEL), LOGGING(콘솔 핸들러, 포맷 `LEVEL [logger] message`).
- **.env** (필수) 예시:
```
DART_API_KEY=your_dart_api_key
ECOS_API_KEY=your_ecos_api_key
SECRET_KEY=your_secret_key
DEBUG=True
```

## 데이터 흐름

1. **데이터 수집**: `DartClient` / `EcosClient` → API 호출
2. **서비스 레이어**: `DartDataService` / `EcosDataService` → 데이터 가공 (백분율을 소수로 변환)
3. **오케스트레이터**: `DataOrchestrator` → 통합 수집 및 조율
4. **모델 객체**: `CompanyFinancialObject` / `FinancialStatementData` → 데이터 저장
5. **DB 저장**: `apps.service.db.save_company_to_db()` → Django ORM 모델로 변환하여 DB 저장
6. **API 응답**: Django REST Framework → JSON 응답
7. **프론트엔드**: Django 템플릿 + Alpine.js → 사용자 인터페이스

### 5. XBRL (`apps/xbrl/`)

비활성·보관용 (표본 부족으로 수집 중단).

### 6. 필터링 서비스 (`apps/service/filter.py`)

- **CompanyFilter**: 영업이익(≤0 연도 ≤1회), 당기순이익(합계>0), 매출액 CAGR≥10%, 영업이익률≥10%, ROE(규모별 임계값) 5가지 필터 + `apply_all_filters()`.

### 7. 유틸리티 및 서비스 헬퍼

- **utils** (stdlib만): `normalize`(계정명 정규화), `format_`(금액 조/억/만), `classify`(기업 규모 분류).
- **service**: `corp_code`(종목코드↔기업번호), `bond_yield`(BondYield 캐시), `db`(수집 여부·연간/분기 저장·조회), `passed_json`, `memo`, `paste_parser`(연결 재무상태표/현금흐름표 텍스트 파싱·계정 매핑·연도별 금액 추출, 계정 한 줄/숫자 다음 줄 형식·전각 숫자·탭 구분 지원).

### 8. 프론트엔드 (`apps/companies/`)

- **뷰**: pages(목록·계산기·상세), api_financial(재무·계산기·분기·메모), api_favorites(즐겨찾기·그룹), api_misc(검색·passed).
- **템플릿**: base(Bootstrap 5 + Alpine.js). list — 목록·검색·즐겨찾기·필터 통과 목록(페이지네이션). detail — 상세·필터 결과·메모·재무표·즐겨찾기. calculator — 상세에서 ?corp_code= 로 진입, 연결 재무상태표·현금흐름표 복붙 두 영역, 국채수익률/법인세율/주주기대수익률 입력 후 parse-paste API로 파싱·FCF/ROIC/WACC 계산·DB 저장.

## 주요 특징

- **필터링**: 5가지 조건(영업이익, 당기순이익, 매출액 CAGR≥10%, 영업이익률≥10%, ROE 규모별).
- **DB 저장**: SQLite, 4월 1일 기준 재수집 판단.
- **데이터 소스**: DART·ECOS API.
- **캐싱**: BondYield 하루 단위, corp_code XML.
- **N+1 방지**: prefetch_related 사용.
- **계산기**: FCF, ROIC, WACC (프론트·백엔드).
- **즐겨찾기·메모**: 그룹별 즐겨찾기 CRUD, 기업별 메모.
- **API Rate Limiting**: API_DELAY로 호출 간 지연.
- **비율 소수 저장**: 0.10=10%, UI에서만 *100.
- **CFS 우선**: 연결/별도 재무제표 동시 시 CFS 우선.
- **종목코드 6자리 지원**: 자동으로 기업번호 변환.
- **기타**: O(1) 계정 조회(FinancialStatementData), 분기보고서 수집·조회, clear_financial_data로 재수집 가능.

