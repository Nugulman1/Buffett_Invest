# 코드 구조 요약

## 프로젝트 개요
장기 투자 필터링 프로그램 - DART·ECOS·KRX API를 활용한 재무 데이터 수집 및 분석. 1차 필터(기본 지표) 통과 후 parse-paste(LLM)로 2차 데이터 수집·EV/IC·ROIC/WACC 계산·2차 필터(ROIC-WACC) 적용. 통과 목록은 DB(Company) 조회.

## 기술 스택
- **프레임워크**: Django 6.0.x
- **API**: Django REST Framework 3.16.x
- **언어**: Python 3.12–3.14 (권장: 3.13)
- **의존성 관리**: requirements.txt
- **환경 변수**: python-dotenv 1.2.x (.env 파일)

## 프로젝트 구조

```
Long_Term_Investing/
├── apps/                    # 애플리케이션 모듈
│   ├── dart/                # DART API 관련
│   │   ├── client.py        # DART API 클라이언트
│   │   ├── views.py         # DART API 뷰
│   │   ├── urls.py          # DART URL 라우팅
│   │   └── apps.py          # DART 앱 설정
│   ├── ecos/                # ECOS API 관련
│   │   ├── client.py        # ECOS API 클라이언트
│   │   ├── views.py         # ECOS API 뷰
│   │   ├── urls.py          # ECOS URL 라우팅
│   │   └── apps.py          # ECOS 앱 설정
│   ├── companies/           # 기업 재무 데이터 조회 프론트엔드
│   │   ├── views/           # 뷰 패키지 (페이지 + API)
│   │   │   ├── pages.py     # 페이지 뷰 (목록, 상세, 계산기)
│   │   │   ├── api_financial.py   # 재무/계산기/분기/메모 API
│   │   │   ├── api_favorites.py   # 즐겨찾기 API
│   │   │   ├── api_misc.py        # 검색, 필터 통과 목록 등 API
│   │   │   └── __init__.py
│   │   ├── urls.py          # 기업 조회 URL 라우팅
│   │   ├── apps.py          # Companies 앱 설정
│   │   └── templates/       # Django 템플릿
│   │       ├── base.html    # 기본 템플릿
│   │       └── companies/
│   │           ├── list.html    # 기업 목록 조회 페이지
│   │           ├── detail.html # 기업 상세 정보 페이지
│   │           └── calculator.html # 재무 지표 계산기 페이지 (FCF, ROIC, WACC)
│   ├── service/             # 데이터 수집·DB·유틸 서비스 레이어
│   │   ├── orchestrator.py  # 데이터 수집 오케스트레이터
│   │   ├── dart.py          # DART 데이터 수집 서비스
│   │   ├── ecos.py          # ECOS 데이터 수집 서비스
│   │   ├── db.py            # DB 레이어 (연간/분기 저장·조회, 수집 여부 판단, 매출액 없을 때 재수집)
│   │   ├── corp_code.py     # 기업번호/종목코드 변환 (DartClient)
│   │   ├── bond_yield.py    # 국채 5년 수익률 조회 (BondYield)
│   │   ├── krx_client.py    # KRX OPEN API (AUTH_KEY). get_daily_data 출력명 그대로 반환, fetch_and_save_company_market_cap → KrxDailyData·Company.market_cap 저장
│   │   ├── memo.py          # 기업 메모 백업/복원
│   │   ├── calculator.py    # 재무 지표 계산 (CAGR, 영업이익률, FCF, ROIC, WACC, 부채비율, EV, IC)
│   │   ├── paste_parser.py  # 복붙 재무제표 파서 (연도·단위 추출, 표 본문 자산/영업 분리, rows JSON, 원 단위 정규화). parse_balance_sheet/parse_cash_flow 반환 직전 _format_parsed_display로 표 형태 출력(연결 재무상태표/현금흐름표)
│   │   ├── llm_extractor.py # LLM 기반 rows → 지표 추출 (cfo, 유형/무형자산취득, 기말현금, 이자비용, 이자부채, dividend_paid, noncontrolling_interest). 연도별 _build_prompt. CFO 부호 유지. 이자부채 breakdown _sum_breakdown. OPENAI_MODEL 기본 gpt-4o
│   │   └── filter.py        # 1차 필터(영업이익·당기순이익·영업이익률·ROE, 매출CAGR 미적용) + 2차 필터 check_second_filter(ROIC-WACC≥설정값)
│   ├── utils/               # 순수 유틸 (stdlib만, 의존성 없음)
│   │   ├── normalize.py     # 계정명 정규화
│   │   ├── format_.py       # 금액 포맷팅 (조/억/만)
│   │   ├── classify.py      # 기업 규모 분류
│   │   └── __init__.py      # re-export
│   ├── models.py            # 데이터 모델 (공통)
│   ├── migrations/          # Django 마이그레이션
│   │   ├── 0001_initial.py  # 초기 마이그레이션 (squashed)
│   │   ├── 0002_remove_company_bond_yield_5y_and_more.py
│   │   ├── 0003_add_nullable_to_yearly_financial.py
│   │   ├── 0004_multi_company_yearly_extension.py # YearlyFinancialData 확장 필드, YearlyFinancialIndicator
│   │   ├── 0005_add_idx_nm_to_yearly_financial_indicator.py
│   │   ├── 0006_add_dividend_paid_to_yearly_financial.py
│   │   ├── 0007_add_debt_ratio_to_yearly_financial.py
│   │   ├── 0008_add_cash_and_cash_equivalents.py
│   │   ├── 0009_add_ev_invested_capital.py
│   │   ├── 0010_add_passed_second_filter.py
│   │   ├── 0011_add_noncontrolling_interest.py
│   │   ├── 0012_add_company_market_cap.py
│   │   └── 0013_add_krx_daily_data.py # KrxDailyData (BAS_DD, IDX_CLSS, ... MKTCAP 출력명 그대로)
├── config/                  # Django 프로젝트 설정
│   ├── settings.py          # 프로젝트 설정
│   ├── urls.py              # 메인 URL 라우팅
│   └── wsgi.py              # WSGI 설정
├── docs/                    # 문서 (TODO.md, 코드 구조 요약.md)
├── debug_paste_parser_balance.py # 재무상태표 파싱 테스트 (balance.txt)
├── debug_paste_parser_cash.py   # 현금흐름표 파싱 테스트 (cash.txt)
├── test_multi_account_collect.py # 다중회사 주요계정 수집 테스트 (--count, --stock, --save, DB 저장 확인·재무 일관성)
├── test_company_collect.py      # 기업 수집 테스트 (주요계정+주요재무지표, --save 시 DB·수치 검증)
├── indicators_mappings.json # 재무제표 계정명 매핑 테이블 (다중회사 확장 필드 포함)
├── db.sqlite3               # SQLite 데이터베이스
├── manage.py                # Django 관리 스크립트
├── collect_all_companies.py # 전체 기업 데이터 수집 스크립트 (100개씩 배치, collect_companies_data_batch)
├── requirements.txt         # Python 패키지 의존성
└── .env                     # 환경 변수 (API 키 등)

```

## 주요 모듈 설명

### 1. 데이터 모델 (`apps/models.py`)

- **ORM 모델**: `Company` (corp_code PK, 필터 결과·**passed_second_filter**·메모·last_collected_at·**market_cap**·**market_cap_updated_at**), `BondYield`, `ApiCallStats`, `YearlyFinancialData` (연도별 재무, company+year unique. 기본+**debt_ratio**·**cash_and_cash_equivalents**·**noncontrolling_interest**·**ev**·**invested_capital**·dividend_paid·fcf·roic·wacc, 다중회사 확장 필드 동일), `YearlyFinancialIndicator`, `QuarterlyFinancialData`, **`KrxDailyData`** (company+BAS_DD unique. KRX 출력명 그대로: BAS_DD, IDX_CLSS, IDX_NM, CLSPRC_IDX, CMPPREVDD_IDX, FLUC_RT, OPNPRC_IDX, HGPRC_IDX, LWPRC_IDX, ACC_TRDVOL, ACC_TRDVAL, MKTCAP), `FavoriteGroup`, `Favorite`.
- 연간/분기 데이터는 Python 객체로 가공 후 ORM 저장.

### 2. DART API 클라이언트 (`apps/dart/client.py`)

- OpenDART API 클라이언트. 기업 정보·재무제표 조회, 종목코드→corp_code 매핑(corpCode.xml 캐시), 일별 호출 통계·재시도·API_DELAY 적용.
- **다중회사 주요계정**: `get_financial_statement_multi(corp_codes, bsns_year, reprt_code)` — fnlttMultiAcnt.json, 최대 100개 회사.
- **다중회사 주요재무지표**: `get_financial_indicators_multi(corp_codes, bsns_year, reprt_code, idx_cl_code)` — fnlttCmpnyIndx.json, 최대 100개 회사. 단일 회사도 corp_codes 1개로 동일 API 사용.
- **분기보고서**: `get_recent_quarterly_reports(corp_code, limit=3)` — 현재 날짜 기준 **최근 1년** 구간 조회 후 분기보고서만 필터, 최대 limit건 반환(사업보고서 접수일 무관). `_is_actual_quarterly_report(report_nm)`으로 실제 분기(재무)보고서만 수집(3분기배당·수시공시 제외). reprt_code 우선, 없으면 report_nm 매칭(동일 검사 적용). `_log_quarterly_reports_debug`로 조회 구간·수집/제외 건수 로그.

### 3. ECOS API 클라이언트 (`apps/ecos/client.py`)

- 한국은행 ECOS API 클라이언트. 국채 5년 수익률 조회(월별), 특정 날짜 이후 분기보고서 목록 조회. 일별 통계·API_DELAY 적용.

### 4. 데이터 수집 서비스 (`apps/service/`)

- **DataOrchestrator**: DART 기본 지표 수집(최근 5년) → 재무지표 계산 → ECOS 채권수익률(BondYield 캐시) → 필터 적용 → DB 저장. **다중회사 배치**: `collect_companies_data_batch(corp_codes)` — `fill_basic_indicators_multi` + `fill_financial_indicators_multi` 호출 후 회사별 yearly_indicators·yearly_indicator_names 병합, 계산·필터·DB 저장. 실패 시 로그만, 반환: corp_code·status·passed_all_filters·company_name·error.
- **DartDataService**: 연간/분기 재무제표 수집, 기본 지표 채우기(매핑표·정규화). **다중회사 연간**: `fill_basic_indicators_multi(corp_codes, years)` — 연도별 fnlttMultiAcnt 호출, **CFS 우선·없으면 OFS fallback**(연결 미제출 회사 대응), 종목코드 6자리 통일(stock_code 매칭). 사업보고서 1건당 당기·전기·전전기 3개 연도 추출. CFS 우선, 분기 병렬(ThreadPoolExecutor). DART 금액 "-" 등 비정상 값은 **None** 저장. **다중회사 주요재무지표**: `fill_financial_indicators_multi(corp_codes, years, idx_cl_codes)` — 연도·지표분류별 fnlttCmpnyIndx 호출, (values_map, names_map) 반환. idx_val은 DART가 소수(0.256)로 주므로 그대로 저장. **분기 수집**: `collect_quarterly_data_for_save(corp_code, limit=3)`.
- **EcosDataService**: 국채 5년 수익률 수집.
- **IndicatorCalculator**: CAGR, 영업이익률, **부채비율**(자본총계/부채총계), FCF, ROIC, WACC, **투하자본(IC)**, **EV**(시총+이자부채-현금+비지배지분) 계산. 비율은 소수 저장. ROE는 DART M211550에서 채움. **FCF/ROIC/WACC**: DB 영업이익·자기자본 None이면 해당 연도 계산 생략.
- **CompanyFilter**: 1차 필터 5가지(영업이익·당기순이익·**매출CAGR 미적용**·영업이익률·ROE) + `apply_all_filters()`. **2차 필터** `check_second_filter(corp_code)`: 최신 연도 ROIC-WACC ≥ settings.SECOND_FILTER_ROIC_WACC_SPREAD. None 연도는 필터 계산에서 제외.
- **krx_client**: KRX OPEN API(AUTH_KEY). `get_daily_data(stock_code)` → 출력명 12개 그대로 반환. `fetch_and_save_company_market_cap(corp_code)` → KrxDailyData 저장·Company.market_cap 갱신. API 키 없으면 호출 생략.

## 관리 명령어

- **`collect_all_companies.py`**: `종목코드.md`에서 종목코드 읽기 → 수집 필요 여부(4월 1일 기준) 확인 → **100개씩 corp_code 슬라이스** → `DataOrchestrator.collect_companies_data_batch(corp_codes)` 호출 → 필터 통과 기업은 DB(Company.passed_all_filters)에 저장. `--limit` 옵션.
- **`test_multi_account_collect.py`**: 다중회사 주요계정 수집만 검증. Django 설정 후 `fill_basic_indicators_multi` 호출(연도·회사별 샘플 로그). `--save` 시 `collect_companies_data_batch` 실행 후 DB 저장 확인(연도별·필드별 출력)·재무 일관성 검사(자산/부채 합계). `--count N`, `--stock 종목코드` 옵션.
- **`test_company_collect.py`**: 기업 수집 전체 검증(주요계정+주요재무지표). `--save` 시 배치 실행 후 DB 저장·예상 지표 15개 검증·지표값 범위 확인. `--count N`, `--stock 종목코드` 옵션.
- **`backup_memos`**: 메모가 있는 기업 메모를 JSON 백업 (`python manage.py backup_memos [--output 파일명]`).
- **`restore_memos`**: JSON 백업에서 메모 복원 (`python manage.py restore_memos <파일> [--confirm]`).
- **`clear_financial_data`**: 재무 기본 필드만 초기화(FCF/ROIC/WACC·메모 보존), 분기 삭제, 재수집 가능 (`[--confirm]`, `--corp-code` 지원).
- **`migrate_passed_txt_to_json`**: Deprecated. 필터 통과 목록은 DB만 사용.

## API 엔드포인트

- **페이지**: `/companies/` (목록·검색), `/companies/calculator/` (FCF/ROIC/WACC 계산기), `/companies/<corp_code>/` (상세).
- **재무·계산기·분기·메모**: `/api/companies/<corp_code>/financial-data/`(yearly_data에 dividend_paid·ev·invested_capital·debt_ratio 포함), `calculator-data/`, `parse-paste/`(POST, 복붙→LLM 추출→FCF/ROIC/WACC·dividend_paid·비지배지분 저장, **parse 마지막에 2차 필터 갱신**), `calculate-ev-ic/`(POST, 시총 없으면 KRX 조회·KrxDailyData 저장 후 EV/IC 계산·저장), `market-cap/`(GET, KRX 조회·KrxDailyData 저장·krx_daily_data 포함 반환), `quarterly-data/`, `memo/`, `calculated-indicators/`, `quarterly-reports/collect/`(POST), `annual-report-link/`.
- **즐겨찾기·그룹**: `/api/companies/favorites/`, `favorite-groups/`, `<corp_code>/favorites/` 등 CRUD.
- **기타**: `/api/companies/passed/` (1차+2차 통과만 **DB 조회**, 페이지네이션), `/api/companies/search/` (기업명·종목코드 6자리·기업번호 8자리 검색).
- **DART**: `GET /api/dart/company/<corp_code>/` — 기업 정보 조회.
- 상세 경로·메서드·파라미터는 `config/urls.py` 및 `apps/companies/views` 참고.

## 설정 파일

- **config/settings.py**: INSTALLED_APPS(rest_framework, apps, dart, ecos, companies), DB(SQLite, 타임아웃 30초), API 키(.env), OPENAI_API_KEY·OPENAI_MODEL(기본 gpt-4o), **KRX_API_KEY·KRX_BASE_URL**(선택), **SECOND_FILTER_ROIC_WACC_SPREAD**(2차 필터, 기본 0.02), CALCULATOR_DEFAULTS, DATA_COLLECTION, LOGGING.
- **.env** (필수/선택) 예시:
```
DART_API_KEY=your_dart_api_key
ECOS_API_KEY=your_ecos_api_key
OPENAI_API_KEY=your_openai_api_key
KRX_API_KEY=your_krx_api_key
SECRET_KEY=your_secret_key
DEBUG=True
```

## 데이터 흐름

1. **데이터 수집**: `DartClient` / `EcosClient` → API 호출
2. **서비스 레이어**: `DartDataService` / `EcosDataService` → 데이터 가공 (백분율을 소수로 변환)
3. **오케스트레이터**: `DataOrchestrator` → 통합 수집 및 조율
4. **모델 객체**: `CompanyFinancialObject` / `FinancialStatementData` → 데이터 저장
5. **DB 저장**: `apps.service.db.save_company_to_db()` → Django ORM 모델로 변환하여 DB 저장
6. **API 응답**: Django REST Framework → JSON 응답
7. **프론트엔드**: Django 템플릿 + Alpine.js → 사용자 인터페이스

### 5. 필터링 서비스 (`apps/service/filter.py`)

- **CompanyFilter**: 영업이익(≤0 연도 ≤1회), 당기순이익(합계>0), 매출액 CAGR≥10%, 영업이익률≥10%, ROE(규모별 임계값) 5가지 필터 + `apply_all_filters()`.

### 6. 유틸리티 및 서비스 헬퍼

- **utils** (stdlib만): `normalize`(계정명 정규화), `format_`(금액 조/억/만), `classify`(기업 규모 분류).
- **service**: `corp_code`(종목코드↔기업번호), `bond_yield`(BondYield 캐시), `krx_client`(KRX 출력명 12개 조회·KrxDailyData·Company.market_cap 저장), `db`(연간/분기 저장·조회, save 시 cash_and_cash_equivalents·noncontrolling_interest·ev·invested_capital 포함), `memo`, `paste_parser`, `llm_extractor`(rows → cfo·이자부채·dividend_paid·noncontrolling_interest 등 8개 필드 추출).

### 7. 프론트엔드 (`apps/companies/`)

- **뷰**: pages(목록·계산기·상세), api_financial(재무·계산기·분기·메모), api_favorites(즐겨찾기·그룹), api_misc(검색·passed).
- **템플릿**: base(Bootstrap 5 + Alpine.js). list — 목록·검색(기업명/종목코드 6자리/기업번호 8자리)·즐겨찾기·필터 통과 목록. detail — 상세·필터 결과·메모·재무표·즐겨찾기. calculator — 국채수익률 페이지 로드 시 ECOS BondYield 자동 채움, 연결 재무상태표·현금흐름표 복붙 → parse-paste API.

## 주요 특징

- **필터링**: 1차 5가지(영업이익·당기순이익·영업이익률·ROE, 매출CAGR 현재 미적용) + 2차 ROIC-WACC≥설정값. 통과 목록은 DB(Company.passed_all_filters, passed_second_filter)만 사용.
- **DB 저장**: SQLite. 재수집 판단: 4월 1일 기준 + yearly_data 없음 또는 **모든 매출액 None/0**이면 수집.
- **데이터 소스**: DART·ECOS·KRX API(시가총액·일별 시세, 출력명 그대로 KrxDailyData 저장).
- **캐싱**: BondYield 하루 단위, corp_code XML.
- **N+1 방지**: prefetch_related 사용.
- **계산기**: 복붙→paste_parser→LLM 추출→FCF/ROIC/WACC 계산·DB 저장. 단위(원/천원/백만원) 자동 처리.
- **즐겨찾기·메모**: 그룹별 즐겨찾기 CRUD, 기업별 메모.
- **API Rate Limiting**: API_DELAY로 호출 간 지연.
- **비율 소수 저장**: 0.10=10%, UI에서만 *100.
- **CFS 우선·OFS fallback**: 연간 다중회사 수집 시 연결(CFS) 우선, 없으면 개별(OFS) 사용.
- **종목코드 6자리·기업번호 8자리**: list 검색·상세 진입 모두 지원. 자동 변환.
- **데이터 없음(-)**: DART 파싱 실패 시 None 저장. 영업이익률은 계산 없으면 None, ROE는 DART M211550 없으면 None. API/UI에서 null → "-" 표시. 필터는 None 연도 제외.
- **기타**: O(1) 계정 조회(FinancialStatementData), 분기보고서 수집·조회, clear_financial_data로 재수집 가능.

