# TODO 리스트

## [최우선] 재무제표 계정명 매핑 구현

### 현재 상태
- ✅ 기본 매핑 테이블 생성 완료 (`indicators_mappings.json`)
  - 자산총계, 자기자본총계, 당기순이익, 영업이익, CFO, 유동부채 매핑 정의
- ⚠️ 실제 DART API 응답 데이터 확인 결과:
  - 자산총계: ✅ 매핑 가능 ("자산총계")
  - 자기자본총계: ⚠️ "자본총계"로 표시됨 (매핑 테이블에 포함)
  - 당기순이익: ⚠️ "당기순이익(손실)"로 표시됨 (매핑 테이블에 포함)
  - 영업이익: ✅ 매핑 가능 ("영업이익")
  - CFO: ❌ 현금흐름표 데이터 필요 (XBRL 파싱 필요)
  - 유동부채: ✅ 매핑 가능 ("유동부채")

### 다음 작업
- [ ] 계정명 매핑 함수 구현 (`apps/service/dart.py` 또는 새 모듈)
  - `indicators_mappings.json` 파일 로드
  - `FinancialStatementData.get_account_value()`와 연동
  - 여러 변형 계정명 시도 로직
- [ ] 매핑 테이블 확장
  - 이자비용, 이자부유동부채, 유형자산 취득, 무형자산 취득 추가
  - 실제 API 응답 기반 변형 추가
- [ ] XBRL 파싱 로직 구현 (CFO 데이터 수집용)
  - XBRL 파일에서 현금흐름표 데이터 추출
  - 영업활동현금흐름(CFO) 추출

## DART API 데이터 수집

### 1. 재무제표 데이터 수집 (최근 5년)
다음 데이터를 DART API에서 가져와야 합니다:

#### 필수 수집 데이터
1. **유형자산 취득** (재무제표)
2. **무형자산 취득** (재무제표)
3. **CFO (영업활동현금흐름)** (현금흐름표)
4. **당기순이익** (손익계산서)
5. **영업이익** (손익계산서)
6. **이자비용** (손익계산서)
7. **자산총계** (재무상태표)
8. **유동부채** (재무상태표)
9. **이자부유동부채** (재무상태표)

### 2. 계산해야 할 지표

#### FCF (Free Cash Flow, 자유현금흐름)
- **계산식**: CFO - (유형자산 취득 + 무형자산 취득)
- **필요 데이터**: CFO, 유형자산 취득, 무형자산 취득

#### ICR (Interest Coverage Ratio, 이자보상비율)
- **계산식**: 영업이익 / 이자비용
- **필요 데이터**: 영업이익, 이자비용
- **단위**: ratio (배수)

#### ROIC (Return on Invested Capital, 투하자본수익률)
- **계산식**: 영업이익 / (자산총계 - 비이자성유동부채)
- **비이자성유동부채**: 유동부채 - 이자부유동부채
- **필요 데이터**: 영업이익, 자산총계, 유동부채, 이자부유동부채
- **단위**: % (백분율)

#### WACC (Weighted Average Cost of Capital, 가중평균자본비용)
- **계산식**: 간소화 버전
  - 채권 수익률 (국채 5년, ECOS에서 수집)
  - 베타: 1 고정
  - MRP (Market Risk Premium): 5% 고정
- **필요 데이터**: 채권 수익률 (ECOS)
- **단위**: % (백분율)

## 구현 작업

### [최우선] 재무제표 계정명 매핑 구현
- [ ] 계정명 매핑 로직 구현 (`indicators_mappings.json` 활용)
  - 매핑 테이블 기반 계정명 변형 처리
  - 유사도 기반 매칭 (fuzzy matching) 구현
  - 매핑 실패 시 로깅 및 처리
- [ ] 계정 데이터 추출 함수 구현
  - 자산총계, 자기자본총계, 당기순이익, 영업이익, CFO, 유동부채 추출
  - 각 계정명의 다양한 변형 처리
- [ ] 매핑 테이블 확장 (`indicators_mappings.json`)
  - 실제 DART API 응답 데이터 기반 계정명 변형 추가
  - 이자비용, 이자부유동부채, 유형자산 취득, 무형자산 취득 등 추가

### 단계 1: DART API 클라이언트 확장 (완료)
- [x] 재무제표 조회 API 메서드 추가 (`get_financial_statement`)
- [x] 종목코드로 기업 정보 조회 (`get_company_basic_info`, `get_company_by_stock_code`)
- [x] 기업 고유번호 조회 (`_get_corp_code_by_stock_code`)
- [x] 공시보고서 목록 조회 (`get_report_list`)
- [x] XBRL 원본 파일 다운로드 (`download_xbrl`)

### 단계 2: DartDataService 구현 (완료)
- [x] `collect_financial_data()` 메서드 구현
  - 최근 5년 연간 보고서 다운로드
  - 각 보고서를 `FinancialStatementData` 객체로 변환
  - O(1) 조회를 위한 인덱싱 구현
- [x] `_get_recent_years()` 연도 자동 계산 로직 구현
- [ ] 필요한 계정 데이터 추출 로직 구현 (매핑 로직 필요)
  - 유형자산 취득
  - 무형자산 취득
  - CFO (현금흐름표 - XBRL 파싱 필요)
  - 당기순이익
  - 영업이익
  - 이자비용
  - 자산총계
  - 유동부채
  - 이자부유동부채

### 단계 3: 지표 계산 로직 구현
- [ ] FCF 계산 로직
- [ ] ICR 계산 로직
- [ ] ROIC 계산 로직
- [ ] WACC 계산 로직 (ECOS 데이터 연동)

### 단계 4: DataOrchestrator 구현
- [ ] `collect_company_data()` 메서드 구현
  - DART 데이터 수집
  - ECOS 데이터 수집 (국채 5년 수익률)
  - `CompanyFinancialObject` 객체 생성 및 채우기
  - 모든 지표 계산 및 저장

### 단계 5: API 엔드포인트 추가
- [ ] 회사 재무 데이터 조회 API
- [ ] 특정 연도 재무제표 조회 API
- [ ] 지표 계산 결과 조회 API

## 산업 분류 기준

### 산업 분류 방법 결정 필요
- [ ] 산업 분류 기준 결정
  - **옵션 1**: DART API의 업종 분류 코드 활용 (있는 경우)
  - **옵션 2**: 한국표준산업분류(KSIC) 코드 활용
  - **옵션 3**: 기업 정보 API에서 제공하는 업종 정보 활용
  - **옵션 4**: 종목코드 기반 시장 분류 활용 (코스피/코스닥 업종 분류)
- [ ] 산업 분류 데이터 수집 방법 구현
  - 기업 정보 조회 API에서 업종 정보 추출
  - 산업 분류 코드 매핑 테이블 생성
- [ ] 산업별 필터링 기능 구현
  - 특정 산업군의 기업만 필터링
  - 산업별 평균 지표 비교

### 산업 분류 고려사항
- DART API의 `get_company_info()` 응답에서 업종 관련 필드 확인 필요
- `business_type_code`, `business_type_name` 필드 활용 가능성 검토
- 필요시 외부 데이터 소스(한국거래소 등)와 연동 고려

## DART 데이터 매핑 전략 (최우선 작업)

### 재무제표 계정명 매핑 (진행 중)
- [x] 기본 매핑 테이블 생성 (`indicators_mappings.json`)
  - 자산총계, 자기자본총계, 당기순이익, 영업이익, CFO, 유동부채 매핑 정의
- [ ] 실제 DART API 응답 데이터 기반 매핑 테이블 확장
  - **유형자산 취득**: "유형자산의 취득", "유형자산 취득" 등 변형 추가
  - **무형자산 취득**: "무형자산의 취득", "무형자산 취득" 등 변형 추가
  - **CFO**: "영업활동으로 인한 현금흐름", "영업활동현금흐름" 등 (현금흐름표)
  - **당기순이익**: "당기순이익(손실)", "당기순이익" 등 (확인 완료)
  - **영업이익**: "영업이익(손실)", "영업이익" 등 (확인 완료)
  - **이자비용**: "이자비용", "이자비용(수익)" 등
  - **자산총계**: "자산총계", "총자산" 등 (확인 완료)
  - **유동부채**: "유동부채", "유동부채합계" 등 (확인 완료)
  - **이자부유동부채**: "이자부유동부채", "이자부담유동부채" 등

### 매핑 로직 구현 (최우선)
- [ ] 계정명 매핑 함수 구현
  - `indicators_mappings.json` 파일 로드
  - DART 계정명을 내부 필드명으로 변환
  - 여러 변형 계정명 시도 (dart_variants 순회)
- [ ] 계정명 정규화 로직 구현
  - 공백 제거, 괄호 제거 등 전처리
  - 유사도 기반 매칭 (fuzzy matching) 고려
  - 계정명 별칭 사전 구축
- [ ] 매핑 실패 시 처리 방법
  - 로깅 및 수동 검토 대상으로 분류
  - 매핑 실패 계정명 목록 관리
- [ ] 단위 통일
  - DART 데이터는 원 단위로 제공
  - 내부 저장 시 단위 통일 (원 단위 유지 또는 천원/백만원 단위 변환 결정)
- [ ] 데이터 검증
  - 음수 값 처리 (손실 표시)
  - 0 값과 결측값 구분
  - 연도별 데이터 일관성 검증

### 매핑 테이블 구조 (예시)
```python
ACCOUNT_MAPPING = {
    '유형자산의 취득': 'tangible_asset_acquisition',
    '무형자산의 취득': 'intangible_asset_acquisition',
    '영업활동으로 인한 현금흐름': 'cfo',
    '당기순이익(손실)': 'net_income',
    # ... 더 많은 매핑
}
```

## 참고사항

### DART API 문서
- OpenDART API: https://opendart.fss.or.kr/guide/main.do
- 재무제표 조회: 사업보고서 (reprt_code: 11011)
- 재무제표 구분: 연결재무제표 (CFS) 또는 별도재무제표 (OFS)
- 기업 정보 조회 API 응답 구조 확인 필요 (업종 정보 포함 여부)

### 데이터 저장 전략
- 현재는 객체 기반으로 데이터 저장
- 모든 데이터 수집 완료 후 DB 스키마 설계 및 마이그레이션 예정

